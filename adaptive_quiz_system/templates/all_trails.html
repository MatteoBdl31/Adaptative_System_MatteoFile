<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Available Trails</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .view-toggle button {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }
        .view-toggle button.active {
            background: #667eea;
            color: white;
        }
        .view-toggle button:hover {
            background: #667eea;
            color: white;
        }
        .view-section {
            display: none;
        }
        .view-section.active {
            display: block;
        }
        #trails-map {
            height: 600px !important;
            width: 100% !important;
            min-height: 400px;
            border-radius: 8px;
            margin-bottom: 30px;
            z-index: 1;
            position: relative;
        }
        .trails-list-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .filter-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .filter-group {
            display: inline-block;
            margin-right: 15px;
            margin-bottom: 10px;
        }
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        .filter-group select, .filter-group input {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üó∫Ô∏è All Available Trails</h1>
            <nav class="nav-links">
                <a href="{{ url_for('index') }}">Home</a>
                <a href="{{ url_for('admin_rules') }}">Admin Rules</a>
            </nav>
        </header>

        <div class="filter-section">
            <h3>Filter Trails</h3>
            <div class="filter-group">
                <label for="filter-difficulty">Difficulty:</label>
                <select id="filter-difficulty">
                    <option value="">All</option>
                    <option value="easy">Easy (‚â§3)</option>
                    <option value="medium">Medium (4-6)</option>
                    <option value="hard">Hard (‚â•7)</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filter-landscape">Landscape:</label>
                <select id="filter-landscape">
                    <option value="">All</option>
                    <option value="lake">Lake</option>
                    <option value="forest">Forest</option>
                    <option value="peaks">Peaks</option>
                    <option value="mountain">Mountain</option>
                    <option value="alpine">Alpine</option>
                    <option value="river">River</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filter-type">Type:</label>
                <select id="filter-type">
                    <option value="">All</option>
                    <option value="loop">Loop</option>
                    <option value="one_way">One Way</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filter-distance">Max Distance (km):</label>
                <input type="number" id="filter-distance" placeholder="No limit" min="0" step="0.5">
            </div>
            <button onclick="applyFilters()" class="btn-secondary" style="margin-top: 20px;">Apply Filters</button>
            <button onclick="clearFilters()" class="btn-secondary" style="margin-top: 20px;">Clear Filters</button>
        </div>

        <div class="view-toggle">
            <button onclick="showView('map')" id="btn-map" class="active">üó∫Ô∏è Map View</button>
            <button onclick="showView('list')" id="btn-list">üìã List View</button>
        </div>

        <!-- Map View -->
        <div id="map-view" class="view-section active">
            <h2>Trail Locations on Map</h2>
            <div id="trails-map"></div>
        </div>

        <!-- List View -->
        <div id="list-view" class="view-section">
            <h2>All Trails ({{ trails|length }})</h2>
            <div class="trails-list-view" id="trails-list">
                {% for trail in trails %}
                <div class="trail-card" data-difficulty="{{ trail.difficulty }}" 
                     data-landscape="{{ trail.landscapes }}" data-type="{{ trail.trail_type }}"
                     data-distance="{{ trail.distance }}" data-trail-id="{{ trail.trail_id }}">
                    {% if trail.latitude and trail.longitude %}
                    <div class="trail-image-placeholder">
                        üèûÔ∏è
                    </div>
                    {% endif %}
                    <div class="trail-content">
                        <h3>{{ trail.name }}</h3>
                        <div class="trail-stats">
                            <span class="difficulty-badge difficulty-{{ 'easy' if trail.difficulty <= 3 else 'medium' if trail.difficulty <= 6 else 'hard' }}">
                                {% if trail.difficulty <= 3 %}Easy
                                {% elif trail.difficulty <= 6 %}Medium
                                {% else %}Hard{% endif %}
                            </span>
                            <span>üìè {{ trail.distance }} km</span>
                            <span>‚è±Ô∏è {{ trail.duration }} min</span>
                            <span>‚õ∞Ô∏è {{ trail.elevation_gain }}m</span>
                        </div>
                        <p class="trail-description">{{ trail.description }}</p>
                        <div class="trail-features">
                            <div class="landscapes">
                                {% for landscape in trail.landscapes.split(',') %}
                                <span class="landscape-tag">{{ landscape.strip() }}</span>
                                {% endfor %}
                            </div>
                            <div class="accessibility">
                                {% if trail.accessibility %}
                                <span class="access-tag">{{ trail.accessibility.split(',')[0] }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div style="margin-top: 10px;">
                            <strong>Type:</strong> {{ trail.trail_type.replace('_', ' ').title() }} | 
                            <strong>Popularity:</strong> ‚≠ê {{ trail.popularity }}/10
                        </div>
                        {% if trail.latitude and trail.longitude %}
                        <a href="#" onclick="showTrailOnMap({{ trail.latitude }}, {{ trail.longitude }}); return false;" 
                           class="btn-secondary" style="margin-top: 10px;">üìç Show on Map</a>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        // Global variables for map and trails
        var map = null;
        var markers = [];
        var polylines = [];
        var currentTrails = [];
        
        // Wait for DOM and Leaflet to be ready before initializing map
        document.addEventListener('DOMContentLoaded', function() {
            // Check if Leaflet is loaded
            if (typeof L === 'undefined') {
                console.error('Leaflet library not loaded!');
                return;
            }
            
            // Check if map container exists
            var mapContainer = document.getElementById('trails-map');
            if (!mapContainer) {
                console.error('Map container not found!');
                return;
            }
            
            // Wait a bit to ensure the container is visible
            setTimeout(function() {
                try {
                    // Check if container is visible
                    var mapView = document.getElementById('map-view');
                    if (mapView && !mapView.classList.contains('active')) {
                        console.log('Map view is hidden, will initialize when shown');
                    }
                    
                    // Initialize map
                    map = L.map('trails-map').setView([45.8, 6.5], 8);
                    
                    // Add OpenStreetMap tiles
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                        maxZoom: 19
                    }).addTo(map);
                    
                    // Invalidate map size to ensure it renders properly
                    setTimeout(function() {
                        if (map) {
                            map.invalidateSize();
                            console.log('Map size invalidated');
                        }
                    }, 200);
                    
                    console.log('Map initialized successfully');
                } catch(e) {
                    console.error('Error initializing map:', e);
                    return;
                }
                
                // Continue with trail data processing
                processTrailData();
            }, 100);
            
            function processTrailData() {

                // Trail data from server
                window.trailsData = [
                {% for trail in trails %}
                {% if trail.latitude and trail.longitude %}
                {
                    id: "{{ trail.trail_id }}",
                    name: {{ trail.name|tojson }},
                    lat: {{ trail.latitude }},
                    lon: {{ trail.longitude }},
                    difficulty: {{ trail.difficulty }},
                    distance: {% if trail.distance is not none %}{{ trail.distance }}{% else %}null{% endif %},
                    duration: {{ trail.duration }},
                    elevation: {% if trail.elevation_gain is not none %}{{ trail.elevation_gain }}{% else %}null{% endif %},
                    landscapes: {{ trail.landscapes|tojson }},
                    type: {{ trail.trail_type|tojson }},
                    description: {{ trail.description|tojson }},
                    popularity: {{ trail.popularity }},
                    coordinates: {% if trail.coordinates %}{{ trail.coordinates|tojson }}{% else %}null{% endif %}
                }{% if not loop.last %},{% endif %}
                {% endif %}
                {% endfor %}
            ];

                // Set current trails
                currentTrails = window.trailsData;

                // Parse coordinates from JSON string if needed
                window.trailsData.forEach(function(trail) {
                    if (trail.coordinates) {
                        // If coordinates is a string, parse it
                        if (typeof trail.coordinates === 'string') {
                            try {
                                trail.coordinates = JSON.parse(trail.coordinates);
                            } catch(e) {
                                console.log('Could not parse coordinates for trail ' + trail.id + ':', e);
                                trail.coordinates = null;
                            }
                        }
                    }
                });

                // Initialize map with all trails
                addTrailsToMap(window.trailsData);
            }
        });

        // Add markers for all trails
        function addTrailsToMap(trails) {
            if (!map) {
                console.error('Map not initialized!');
                return;
            }
            
            // Clear existing markers and polylines
            markers.forEach(function(marker) {
                map.removeLayer(marker);
            });
            polylines.forEach(function(polyline) {
                map.removeLayer(polyline);
            });
            markers = [];
            polylines = [];

            var bounds = [];
            trails.forEach(function(trail) {
                var marker = L.marker([trail.lat, trail.lon])
                    .addTo(map)
                    .bindPopup(
                        '<strong>' + (trail.name || 'Unnamed Trail') + '</strong><br>' +
                        'Difficulty: ' + (trail.difficulty <= 3 ? 'Easy' : trail.difficulty <= 6 ? 'Medium' : 'Hard') + '<br>' +
                        'Distance: ' + (trail.distance !== null ? trail.distance + ' km' : 'N/A') + '<br>' +
                        'Duration: ' + trail.duration + ' min<br>' +
                        'Elevation: ' + (trail.elevation !== null ? trail.elevation + 'm' : 'N/A') + '<br>' +
                        '‚≠ê ' + trail.popularity + '/10'
                    );
                markers.push(marker);
                bounds.push([trail.lat, trail.lon]);

                // Add trail path if coordinates available
                if (trail.coordinates) {
                    // Parse coordinates if it's still a string
                    var coordData = trail.coordinates;
                    if (typeof coordData === 'string') {
                        try {
                            coordData = JSON.parse(coordData);
                        } catch(e) {
                            console.log('Could not parse coordinates for trail ' + trail.id + ':', e);
                            coordData = null;
                        }
                    }
                    
                    if (coordData && coordData.coordinates && Array.isArray(coordData.coordinates)) {
                        // Convert GeoJSON coordinates [lon, lat] to Leaflet [lat, lon]
                        var latLngs = coordData.coordinates.map(function(coord) {
                            return [coord[1], coord[0]];
                        });
                        
                        var polyline = L.polyline(latLngs, {
                            color: '#667eea',
                            weight: 4,
                            opacity: 0.7
                        }).addTo(map);
                        
                        polylines.push(polyline);
                        
                        // Extend bounds to include the entire trail path
                        var polylineBounds = polyline.getBounds();
                        bounds.push(polylineBounds.getSouthWest());
                        bounds.push(polylineBounds.getNorthEast());
                    }
                }
            });

            // Fit map to show all markers
            if (bounds.length > 0) {
                map.fitBounds(bounds, {padding: [50, 50]});
            }
        }

        // Show trail on map (from list view)
        function showTrailOnMap(lat, lon) {
            showView('map');
            if (map) {
                map.setView([lat, lon], 13);
                // Highlight the marker
                markers.forEach(function(marker) {
                    if (Math.abs(marker.getLatLng().lat - lat) < 0.001 && 
                        Math.abs(marker.getLatLng().lng - lon) < 0.001) {
                        marker.openPopup();
                    }
                });
            }
        }

        // View toggle
        function showView(view) {
            document.getElementById('map-view').classList.toggle('active', view === 'map');
            document.getElementById('list-view').classList.toggle('active', view === 'list');
            document.getElementById('btn-map').classList.toggle('active', view === 'map');
            document.getElementById('btn-list').classList.toggle('active', view === 'list');
            
            // If switching to map view, invalidate map size to ensure it renders
            if (view === 'map' && map) {
                setTimeout(function() {
                    map.invalidateSize();
                }, 100);
            }
        }

        // Filter functions
        function applyFilters() {
            var difficultyFilter = document.getElementById('filter-difficulty').value;
            var landscapeFilter = document.getElementById('filter-landscape').value;
            var typeFilter = document.getElementById('filter-type').value;
            var distanceFilter = document.getElementById('filter-distance').value;

            // Get trailsData from the global scope
            var trailsData = currentTrails.length > 0 ? currentTrails : window.trailsData || [];
            
            var filteredTrails = trailsData.filter(function(trail) {
                // Difficulty filter
                if (difficultyFilter === 'easy' && trail.difficulty > 3) return false;
                if (difficultyFilter === 'medium' && (trail.difficulty <= 3 || trail.difficulty > 6)) return false;
                if (difficultyFilter === 'hard' && trail.difficulty <= 6) return false;

                // Landscape filter
                if (landscapeFilter && !trail.landscapes.toLowerCase().includes(landscapeFilter.toLowerCase())) return false;

                // Type filter
                if (typeFilter && trail.type !== typeFilter) return false;

                // Distance filter
                if (distanceFilter && trail.distance !== null && trail.distance > parseFloat(distanceFilter)) return false;

                return true;
            });

            currentTrails = filteredTrails;
            addTrailsToMap(filteredTrails);
            filterList(filteredTrails);
        }

        function filterList(filteredTrails) {
            var trailCards = document.querySelectorAll('.trail-card');
            
            trailCards.forEach(function(card) {
                var trailId = card.getAttribute('data-trail-id');
                // Check if this trail matches filters
                var difficulty = parseFloat(card.getAttribute('data-difficulty'));
                var landscape = card.getAttribute('data-landscape').toLowerCase();
                var type = card.getAttribute('data-type');
                var distance = parseFloat(card.getAttribute('data-distance'));

                var difficultyFilter = document.getElementById('filter-difficulty').value;
                var landscapeFilter = document.getElementById('filter-landscape').value;
                var typeFilter = document.getElementById('filter-type').value;
                var distanceFilter = document.getElementById('filter-distance').value;

                var show = true;

                if (difficultyFilter === 'easy' && difficulty > 3) show = false;
                if (difficultyFilter === 'medium' && (difficulty <= 3 || difficulty > 6)) show = false;
                if (difficultyFilter === 'hard' && difficulty <= 6) show = false;
                if (landscapeFilter && !landscape.includes(landscapeFilter.toLowerCase())) show = false;
                if (typeFilter && type !== typeFilter) show = false;
                if (distanceFilter && distance > parseFloat(distanceFilter)) show = false;

                card.style.display = show ? 'block' : 'none';
            });
        }

        function clearFilters() {
            document.getElementById('filter-difficulty').value = '';
            document.getElementById('filter-landscape').value = '';
            document.getElementById('filter-type').value = '';
            document.getElementById('filter-distance').value = '';
            currentTrails = window.trailsData || [];
            addTrailsToMap(currentTrails);
            filterList(currentTrails);
            document.querySelectorAll('.trail-card').forEach(function(card) {
                card.style.display = 'block';
            });
        }
    </script>
</body>
</html>

