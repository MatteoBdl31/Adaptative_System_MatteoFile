{% set demo_user_id = result.scenario.user_id|default(result.user_id)|default(1) %}
<div class="demo-panel panel-card" data-user-index="{{ result.scenario.user_id|default(result.user_id|default('1')) }}" data-connection="{{ result.context.get('connection', 'strong') }}" data-user-id="{{ demo_user_id }}">
    <div class="result-panel__content">
        <div class="panel-header">
            <div class="result-panel__title-wrapper">
                <h2 class="result-panel__title">{{ result.scenario.title }}</h2>
                <button type="button" class="context-info-btn" aria-label="Show context information and recommendations" data-user-idx>
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1.5" fill="none"/>
                        <path d="M8 11V8M8 5H8.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <span class="badge">{{ result.active_rules|length }} rules</span>
        </div>

        <div class="demo-view-toggle">
            <button type="button" class="view-toggle-btn" data-view="map" data-panel-id="demo-panel-{{ result.scenario.user_id }}">üó∫Ô∏è Map</button>
            <button type="button" class="view-toggle-btn active" data-view="list" data-panel-id="demo-panel-{{ result.scenario.user_id }}">üìã List</button>
            <button type="button" class="view-toggle-btn" data-view="cards" data-panel-id="demo-panel-{{ result.scenario.user_id }}">üÉè Cards</button>
        </div>

        <div class="demo-results" data-panel-id="demo-panel-{{ result.scenario.user_id }}">
        {# Map View #}
        <div class="demo-view-section demo-view-map hidden" data-view="map">
            <div class="map-container">
                <div class="demo-map" id="demo-map-{{ result.scenario.user_id|default(result.user_id|default('1')) }}" data-user-id="{{ result.scenario.user_id|default(result.user_id|default('1')) }}" data-user-label="{{ result.user_label|default('User') }}"></div>
                <div class="map-legend">
                <div class="legend-item">
                    <span class="legend-marker exact-marker"></span>
                    <span>Exact Match</span>
                </div>
                <div class="legend-item">
                    <span class="legend-marker suggestion-marker"></span>
                    <span>Suggestion</span>
                </div>
                <div class="legend-item">
                    <span class="legend-marker legend-marker--with-ring">
                        <svg width="18" height="18" viewBox="0 0 18 18">
                            <circle cx="9" cy="9" r="8" fill="none"/>
                        </svg>
                    </span>
                    <span>Collaborative (with ring)</span>
                </div>
                </div>
            </div>
        </div>

        {# List View (default visible view) #}
        <div class="demo-view-section demo-view-list active" data-view="list">
            <div class="result-section">
                <div class="section-header">
                    <h3>üéØ Recommended ({{ result.exact|length }})</h3>
                    <small>Perfect matches for this situation</small>
                </div>
                {% if result.exact %}
                <div class="trail-list modern">
                    {% for trail in result.exact %}
                    {% set view_type_str = trail.view_type|default('') %}
                    {% set is_collab_from_view = 'collaborative' in view_type_str if view_type_str else False %}
                    {% set show_collab_icon = trail.is_collaborative or is_collab_from_view %}
                    <div class="trail-card modern recommended" data-trail-id="{{ trail.trail_id }}">
                        <div class="card-heading">
                            <a href="{{ url_for('profile_trail_detail', user_id=demo_user_id, trail_id=trail.trail_id) }}" class="trail-name-link">{{ trail.name }}</a>
                            <div class="card-heading__meta">
                                <button type="button" class="btn-save-trail-demo btn btn-secondary btn--sm" data-trail-id="{{ trail.trail_id }}" data-user-id="{{ demo_user_id }}">Save Trail</button>
                                {% if show_collab_icon %}
                                <div class="collaborative-icon-wrapper" tabindex="0" role="img" aria-label="Similar profiles like it">
                                    <svg class="collaborative-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="10" cy="10" r="9" fill="rgb(14, 165, 233)" stroke="#fff" stroke-width="1"/>
                                        <path d="M10 4.5L11.8 8.2L15.9 9.1L13.1 11.8L13.6 15.9L10 14.2L6.4 15.9L6.9 11.8L4.1 9.1L8.2 8.2L10 4.5Z" fill="#fff"/>
                                    </svg>
                                    <span class="collaborative-icon-tooltip">Similar profiles likes it</span>
                                </div>
                                {% endif %}
                                <span class="pill difficulty-{{ 'easy' if trail.difficulty <= 3 else 'medium' if trail.difficulty <= 6 else 'hard' }}">
                                    {% if trail.difficulty <= 3 %}Easy{% elif trail.difficulty <= 6 %}Medium{% else %}Hard{% endif %}
                                </span>
                                <button type="button" class="trail-explanation-btn" aria-label="Why was this recommended?" data-trail-id="{{ trail.trail_id }}" data-user-idx>
                                    <svg width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M8 2C4.69 2 2 4.69 2 8C2 11.31 4.69 14 8 14C11.31 14 14 11.31 14 8C14 4.69 11.31 2 8 2Z" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                        <path d="M8 5.5V8.5M8 11H8.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="trail-stats">
                            <span>{{ trail.distance or '‚Äî' }} km</span>
                            <span>{{ trail.duration|format_duration }}</span>
                            <span>{{ trail.elevation_gain or '‚Äî' }} m</span>
                            {% if trail.forecast_weather %}<span>{% if trail.forecast_weather == 'sunny' %}‚òÄÔ∏è{% elif trail.forecast_weather == 'cloudy' %}‚òÅÔ∏è{% elif trail.forecast_weather == 'rainy' %}üåßÔ∏è{% elif trail.forecast_weather == 'snowy' %}‚ùÑÔ∏è{% elif trail.forecast_weather == 'storm_risk' %}‚õàÔ∏è{% else %}üå§Ô∏è{% endif %} {{ trail.forecast_weather|title }}</span>{% endif %}
                        </div>
                        <div class="trail-explanation-content" id="trail-explanation-{{ trail.trail_id }}">
                            <div class="trail-explanation-loading"><span class="spinner">‚è≥</span> Generating...</div>
                            <div class="trail-explanation-loaded">
                                <p class="trail-explanation-text"></p>
                                <ul class="trail-explanation-factors"></ul>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                    <p class="empty">No direct matches for this scenario.</p>
                {% endif %}
            </div>

            <div class="result-section">
                <div class="section-header">
                    <h3>‚ú® Additional suggestions ({{ result.suggestions|length }})</h3>
                    <small>High potential even if slightly off the brief</small>
                </div>
                {% if result.suggestions %}
                <div class="trail-list subtle modern">
                    {% for trail in result.suggestions %}
                    {% set view_type_str = trail.view_type|default('') %}
                    {% set is_collab_from_view = 'collaborative' in view_type_str if view_type_str else False %}
                    {% set show_collab_icon = trail.is_collaborative or is_collab_from_view %}
                    <div class="trail-card modern suggested" data-trail-id="{{ trail.trail_id }}" data-is-collab="{{ show_collab_icon|lower }}" data-view-type="{{ view_type_str }}">
                        <div class="card-heading">
                            <a href="{{ url_for('profile_trail_detail', user_id=demo_user_id, trail_id=trail.trail_id) }}" class="trail-name-link">{{ trail.name }}</a>
                            <div class="card-heading__meta">
                                <button type="button" class="btn-save-trail-demo btn btn-secondary btn--sm" data-trail-id="{{ trail.trail_id }}" data-user-id="{{ demo_user_id }}">Save Trail</button>
                                {% if show_collab_icon %}
                                <div class="collaborative-icon-wrapper" tabindex="0" role="img" aria-label="Similar profiles like it">
                                    <svg class="collaborative-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="10" cy="10" r="9" fill="rgb(14, 165, 233)" stroke="#fff" stroke-width="1"/>
                                        <path d="M10 4.5L11.8 8.2L15.9 9.1L13.1 11.8L13.6 15.9L10 14.2L6.4 15.9L6.9 11.8L4.1 9.1L8.2 8.2L10 4.5Z" fill="#fff"/>
                                    </svg>
                                    <span class="collaborative-icon-tooltip">Similar profiles likes it</span>
                                </div>
                                {% endif %}
                                <span class="relevance-badge">{{ "%.0f"|format(trail.relevance_percentage|default(0.0)) }}%</span>
                                <button type="button" class="trail-explanation-btn" aria-label="Why was this recommended?" data-trail-id="{{ trail.trail_id }}" data-user-idx>
                                    <svg width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M8 2C4.69 2 2 4.69 2 8C2 11.31 4.69 14 8 14C11.31 14 14 11.31 14 8C14 4.69 11.31 2 8 2Z" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                        <path d="M8 5.5V8.5M8 11H8.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="trail-stats">
                            <span>{{ trail.distance or '‚Äî' }} km</span>
                            <span>{{ trail.duration|format_duration }}</span>
                            <span>{{ trail.elevation_gain or '‚Äî' }} m</span>
                            {% if trail.forecast_weather %}<span>{% if trail.forecast_weather == 'sunny' %}‚òÄÔ∏è{% elif trail.forecast_weather == 'cloudy' %}‚òÅÔ∏è{% elif trail.forecast_weather == 'rainy' %}üåßÔ∏è{% elif trail.forecast_weather == 'snowy' %}‚ùÑÔ∏è{% elif trail.forecast_weather == 'storm_risk' %}‚õàÔ∏è{% else %}üå§Ô∏è{% endif %} {{ trail.forecast_weather|title }}</span>{% endif %}
                        </div>
                        <div class="trail-explanation-content" id="trail-explanation-{{ trail.trail_id }}">
                            <div class="trail-explanation-loading"><span class="spinner">‚è≥</span> Generating...</div>
                            <div class="trail-explanation-loaded">
                                <p class="trail-explanation-text"></p>
                                <ul class="trail-explanation-factors"></ul>
                            </div>
                        </div>
                        {% if trail.unmatched_criteria %}
                        <div class="unmatched-criteria">
                            <small class="unmatched-label">Missing criteria:</small>
                            <ul class="unmatched-list">
                                {% for criteria in trail.unmatched_criteria %}
                                <li class="unmatched-item">{{ criteria }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                    <p class="empty">No additional suggestions for this scenario.</p>
                {% endif %}
            </div>

            {% if result.collaborative is defined and result.collaborative %}
            <div class="result-section">
                <div class="section-header">
                    <h3>üë• Popular with Similar Hikers ({{ result.collaborative|length }})</h3>
                    <small>Trails loved by other users with the same profile</small>
                </div>
                <div class="trail-list subtle modern">
                    {% for trail in result.collaborative %}
                    <div class="trail-card modern collaborative">
                        <div class="card-heading">
                            <a href="{{ url_for('profile_trail_detail', user_id=demo_user_id, trail_id=trail.trail_id) }}" class="trail-name-link">{{ trail.name }}</a>
                            <div class="card-heading__meta">
                                <button type="button" class="btn-save-trail-demo btn btn-secondary btn--sm" data-trail-id="{{ trail.trail_id }}" data-user-id="{{ demo_user_id }}">Save Trail</button>
                                <span class="badge badge--collaborative">
                                    ‚≠ê {{ trail.collaborative_avg_rating|default('N/A') }}/5 ({{ trail.collaborative_user_count|default(0) }} users)
                                </span>
                                <button type="button" class="trail-explanation-btn" aria-label="Why was this recommended?" data-trail-id="{{ trail.trail_id }}" data-user-idx>
                                    <svg width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M8 2C4.69 2 2 4.69 2 8C2 11.31 4.69 14 8 14C11.31 14 14 11.31 14 8C14 4.69 11.31 2 8 2Z" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                        <path d="M8 5.5V8.5M8 11H8.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="trail-stats">
                            <span>{{ trail.distance or '‚Äî' }} km</span>
                            <span>{{ trail.duration|format_duration }}</span>
                            <span>{{ trail.elevation_gain or '‚Äî' }} m</span>
                            {% if trail.forecast_weather %}<span>{% if trail.forecast_weather == 'sunny' %}‚òÄÔ∏è{% elif trail.forecast_weather == 'cloudy' %}‚òÅÔ∏è{% elif trail.forecast_weather == 'rainy' %}üåßÔ∏è{% elif trail.forecast_weather == 'snowy' %}‚ùÑÔ∏è{% elif trail.forecast_weather == 'storm_risk' %}‚õàÔ∏è{% else %}üå§Ô∏è{% endif %} {{ trail.forecast_weather|title }}</span>{% endif %}
                        </div>
                        {% if trail.recommendation_reason %}
                        <div class="alert--collaborative">
                            <small class="alert-title">
                                üí° {{ trail.recommendation_reason }}
                            </small>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        {# Card View (available in all modes) #}
        <div class="demo-view-section demo-view-cards hidden" data-view="cards">
            <div class="result-section">
                <div class="section-header">
                    <h3>üéØ Recommended ({{ result.exact|length }})</h3>
                    <small>Perfect matches for this situation</small>
                </div>
                {% if result.exact %}
                <div class="trails-grid modern">
                    {% for trail in result.exact %}
                    {% set is_collab = trail.is_collaborative|default(False) %}
                    {% set view_type_str = trail.view_type|default('') %}
                    {% set is_collab_from_view = 'collaborative' in view_type_str if view_type_str else False %}
                    {% set show_collab_icon = is_collab or is_collab_from_view %}
                    <div class="trail-card modern recommended demo-trail-card-with-map"
                         data-trail-id="{{ trail.trail_id }}"
                         data-lat="{{ trail.latitude or '' }}"
                         data-lon="{{ trail.longitude or '' }}"
                         data-coordinates="{% if trail.coordinates %}{{ trail.coordinates|tojson }}{% else %}null{% endif %}">
                        {% if trail.latitude and trail.longitude %}
                        <div class="demo-trail-card-map-container">
                            <div class="demo-trail-mini-map" id="demo-mini-map-{{ trail.trail_id }}-exact"></div>
                        </div>
                        {% endif %}
                        <div class="demo-trail-card-content">
                            <div>
                                <div class="card-heading">
                                    <h3><a href="{{ url_for('profile_trail_detail', user_id=demo_user_id, trail_id=trail.trail_id) }}" class="trail-name-link">{{ trail.name }}</a></h3>
                                    <div class="card-heading__meta">
                                        <button type="button" class="btn-save-trail-demo btn btn-secondary btn--sm" data-trail-id="{{ trail.trail_id }}" data-user-id="{{ demo_user_id }}">Save Trail</button>
                                        {% if show_collab_icon %}
                                        <svg class="collaborative-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" title="Similar profiles likes it">
                                            <circle cx="10" cy="10" r="9" fill="rgb(14, 165, 233)" stroke="#fff" stroke-width="1"/>
                                            <path d="M10 6L11.5 9.5L15 10.5L12 13L12.5 16.5L10 15L7.5 16.5L8 13L5 10.5L8.5 9.5L10 6Z" fill="#fff"/>
                                        </svg>
                                        {% endif %}
                                        <span class="pill difficulty-{{ 'easy' if trail.difficulty <= 3 else 'medium' if trail.difficulty <= 6 else 'hard' }}">
                                            {% if trail.difficulty <= 3 %}Easy{% elif trail.difficulty <= 6 %}Medium{% else %}Hard{% endif %}
                                        </span>
                                        <button type="button" class="trail-explanation-btn" aria-label="Why was this recommended?" data-trail-id="{{ trail.trail_id }}" data-user-idx>
                                            <svg width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M8 2C4.69 2 2 4.69 2 8C2 11.31 4.69 14 8 14C11.31 14 14 11.31 14 8C14 4.69 11.31 2 8 2Z" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                                <path d="M8 5.5V8.5M8 11H8.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <p class="trail-description">{{ trail.description or 'No description available' }}</p>
                            </div>
                            <div class="trail-explanation-content" id="trail-explanation-{{ trail.trail_id }}">
                                <div class="trail-explanation-loading"><span class="spinner">‚è≥</span> Generating...</div>
                                <div class="trail-explanation-loaded">
                                    <p class="trail-explanation-text"></p>
                                    <ul class="trail-explanation-factors"></ul>
                                </div>
                            </div>
                            <div class="trail-stats">
                                <span>üìè {{ trail.distance or '‚Äî' }} km</span>
                                <span>‚è± {{ trail.duration|format_duration }}</span>
                                <span>‚õ∞ {{ trail.elevation_gain or '‚Äî' }} m</span>
                                {% if trail.forecast_weather %}<span>{% if trail.forecast_weather == 'sunny' %}‚òÄÔ∏è{% elif trail.forecast_weather == 'cloudy' %}‚òÅÔ∏è{% elif trail.forecast_weather == 'rainy' %}üåßÔ∏è{% elif trail.forecast_weather == 'snowy' %}‚ùÑÔ∏è{% elif trail.forecast_weather == 'storm_risk' %}‚õàÔ∏è{% else %}üå§Ô∏è{% endif %} {{ trail.forecast_weather|title }}</span>{% endif %}
                            </div>
                            {% if trail.landscapes %}
                            <div class="landscapes">
                                {% for landscape in trail.landscapes.split(',') %}
                                <span class="landscape-chip">{{ landscape.strip().title() }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                    <p class="empty">No direct matches for this scenario.</p>
                {% endif %}
            </div>

            <div class="result-section">
                <div class="section-header">
                    <h3>‚ú® Additional suggestions ({{ result.suggestions|length }})</h3>
                    <small>High potential even if slightly off the brief</small>
                </div>
                {% if result.suggestions %}
                <div class="trails-grid modern">
                    {% for trail in result.suggestions %}
                    {% set view_type_str = trail.view_type|default('') %}
                    {% set is_collab_from_view = 'collaborative' in view_type_str if view_type_str else False %}
                    {% set show_collab_icon = trail.is_collaborative or is_collab_from_view %}
                    <div class="trail-card modern suggested demo-trail-card-with-map"
                         data-trail-id="{{ trail.trail_id }}"
                         data-lat="{{ trail.latitude or '' }}"
                         data-lon="{{ trail.longitude or '' }}"
                         data-coordinates="{% if trail.coordinates %}{{ trail.coordinates|tojson }}{% else %}null{% endif %}"
                         data-is-collab-raw="{{ show_collab_icon|lower }}"
                         {% if show_collab_icon %}data-is-collaborative="true"{% endif %}>
                        {% if trail.latitude and trail.longitude %}
                        <div class="demo-trail-card-map-container">
                            <div class="demo-trail-mini-map" id="demo-mini-map-{{ trail.trail_id }}-suggestion"></div>
                        </div>
                        {% endif %}
                        <div class="demo-trail-card-content">
                            <div class="card-heading">
                                <h3><a href="{{ url_for('profile_trail_detail', user_id=demo_user_id, trail_id=trail.trail_id) }}" class="trail-name-link">{{ trail.name }}</a></h3>
                                <div class="card-heading__meta">
                                    <button type="button" class="btn-save-trail-demo btn btn-secondary btn--sm" data-trail-id="{{ trail.trail_id }}" data-user-id="{{ demo_user_id }}">Save Trail</button>
                                    {% if show_collab_icon %}
                                    <svg class="collaborative-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" title="Similar profiles likes it">
                                        <circle cx="10" cy="10" r="9" fill="rgb(14, 165, 233)" stroke="#fff" stroke-width="1"/>
                                        <path d="M10 6L11.5 9.5L15 10.5L12 13L12.5 16.5L10 15L7.5 16.5L8 13L5 10.5L8.5 9.5L10 6Z" fill="#fff"/>
                                    </svg>
                                    {% endif %}
                                    <span class="relevance-badge">{{ "%.0f"|format(trail.relevance_percentage|default(0.0)) }}% match</span>
                                    {% if show_collab_icon %}
                                    <span class="badge badge--collaborative badge--sm">üë• {{ trail.collaborative_user_count|default(0) }}</span>
                                    {% endif %}
                                    <button type="button" class="trail-explanation-btn" aria-label="Why was this recommended?" data-trail-id="{{ trail.trail_id }}" data-user-idx>
                                        <svg width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M8 2C4.69 2 2 4.69 2 8C2 11.31 4.69 14 8 14C11.31 14 14 11.31 14 8C14 4.69 11.31 2 8 2Z" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                            <path d="M8 5.5V8.5M8 11H8.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="trail-explanation-content" id="trail-explanation-{{ trail.trail_id }}">
                                <div class="trail-explanation-loading"><span class="spinner">‚è≥</span> Generating...</div>
                                <div class="trail-explanation-loaded">
                                    <p class="trail-explanation-text"></p>
                                    <ul class="trail-explanation-factors"></ul>
                                </div>
                            </div>
                            <div class="trail-stats">
                                <span>üìè {{ trail.distance or '‚Äî' }} km</span>
                                <span>‚è± {{ trail.duration|format_duration }}</span>
                                <span>‚õ∞ {{ trail.elevation_gain or '‚Äî' }} m</span>
                                {% if trail.forecast_weather %}<span>{% if trail.forecast_weather == 'sunny' %}‚òÄÔ∏è{% elif trail.forecast_weather == 'cloudy' %}‚òÅÔ∏è{% elif trail.forecast_weather == 'rainy' %}üåßÔ∏è{% elif trail.forecast_weather == 'snowy' %}‚ùÑÔ∏è{% elif trail.forecast_weather == 'storm_risk' %}‚õàÔ∏è{% else %}üå§Ô∏è{% endif %} {{ trail.forecast_weather|title }}</span>{% endif %}
                            </div>
                            {% if trail.landscapes %}
                            <div class="landscapes">
                                {% for landscape in trail.landscapes.split(',') %}
                                <span class="landscape-chip">{{ landscape.strip().title() }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                            {% set is_collab = trail.is_collaborative|default(False) %}
                            {% set view_type_str = trail.view_type|default('') %}
                            {% set is_collab_from_view = 'collaborative' in view_type_str if view_type_str else False %}
                            {% set show_collab_icon = is_collab or is_collab_from_view %}
                            {% if show_collab_icon and trail.recommendation_reason %}
                            <div class="alert--collaborative"><small class="alert-title">üí° {{ trail.recommendation_reason }}</small></div>
                            {% endif %}
                            {% if trail.unmatched_criteria %}
                            <div class="unmatched-criteria">
                                <small class="unmatched-label">Missing criteria:</small>
                                <ul class="unmatched-list">
                                    {% for criteria in trail.unmatched_criteria %}
                                    <li class="unmatched-item">{{ criteria }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                    <p class="empty">No additional suggestions for this scenario.</p>
                {% endif %}
            </div>

            {% if result.collaborative %}
            <div class="result-section">
                <div class="section-header">
                    <h3>üë• Popular with Similar Hikers ({{ result.collaborative|length }})</h3>
                    <small>Trails loved by other users with the same profile</small>
                </div>
                <div class="trails-grid modern">
                    {% for trail in result.collaborative %}
                    <div class="trail-card modern collaborative demo-trail-card-with-map"
                         data-trail-id="{{ trail.trail_id }}"
                         data-lat="{{ trail.latitude or '' }}"
                         data-lon="{{ trail.longitude or '' }}"
                         data-coordinates="{% if trail.coordinates %}{{ trail.coordinates|tojson }}{% else %}null{% endif %}"
                         data-is-collaborative="true">
                        {% if trail.latitude and trail.longitude %}
                        <div class="demo-trail-card-map-container">
                            <div class="demo-trail-mini-map" id="demo-mini-map-{{ trail.trail_id }}-collaborative"></div>
                        </div>
                        {% endif %}
                        <div class="demo-trail-card-content">
                            <div class="card-heading">
                                <h3><a href="{{ url_for('profile_trail_detail', user_id=demo_user_id, trail_id=trail.trail_id) }}" class="trail-name-link">{{ trail.name }}</a></h3>
                                <div class="card-heading__meta">
                                    <button type="button" class="btn-save-trail-demo btn btn-secondary btn--sm" data-trail-id="{{ trail.trail_id }}" data-user-id="{{ demo_user_id }}">Save Trail</button>
                                    <span class="badge badge--collaborative">‚≠ê {{ trail.collaborative_avg_rating|default('N/A') }}/5 ({{ trail.collaborative_user_count|default(0) }} users)</span>
                                    <button type="button" class="trail-explanation-btn" aria-label="Why was this recommended?" data-trail-id="{{ trail.trail_id }}" data-user-idx>
                                        <svg width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M8 2C4.69 2 2 4.69 2 8C2 11.31 4.69 14 8 14C11.31 14 14 11.31 14 8C14 4.69 11.31 2 8 2Z" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                            <path d="M8 5.5V8.5M8 11H8.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <p class="trail-description">{{ trail.description or 'No description available' }}</p>
                            <div class="trail-stats">
                                <span>üìè {{ trail.distance or '‚Äî' }} km</span>
                                <span>‚è± {{ trail.duration|format_duration }}</span>
                                <span>‚õ∞ {{ trail.elevation_gain or '‚Äî' }} m</span>
                                {% if trail.forecast_weather %}<span>{% if trail.forecast_weather == 'sunny' %}‚òÄÔ∏è{% elif trail.forecast_weather == 'cloudy' %}‚òÅÔ∏è{% elif trail.forecast_weather == 'rainy' %}üåßÔ∏è{% elif trail.forecast_weather == 'snowy' %}‚ùÑÔ∏è{% elif trail.forecast_weather == 'storm_risk' %}‚õàÔ∏è{% else %}üå§Ô∏è{% endif %} {{ trail.forecast_weather|title }}</span>{% endif %}
                            </div>
                            {% if trail.landscapes %}
                            <div class="landscapes">
                                {% for landscape in trail.landscapes.split(',') %}
                                <span class="landscape-chip">{{ landscape.strip().title() }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                            {% if trail.recommendation_reason %}
                            <div class="alert--collaborative"><small class="alert-title">üí° {{ trail.recommendation_reason }}</small></div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        {# Display settings and rules (shown in all views) #}
        <div class="result-section demo-meta-section">
            <div class="section-header">
                <h3>üìê Display adjustments</h3>
                <small>Tunings applied to the UI</small>
            </div>
            <ul class="display-settings">
                {% for key, value in result.display.items() %}
                    <li><code>{{ key }}</code> ‚Üí <strong>{{ value }}</strong></li>
                {% endfor %}
            </ul>
        </div>

        <div class="result-section demo-meta-section">
            <div class="section-header">
                <h3>üß† Matching rules</h3>
            </div>
            <ul class="rules-list">
                {% for rule in result.active_rules %}
                    <li>
                        <strong>{{ rule.description or rule.condition }}</strong>
                        <span>{{ rule.condition }}</span>
                    </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    </div><!-- /.result-panel__content -->

    <!-- Context Info Modal with Tabs -->
    <div class="context-modal" id="context-modal-idx" role="dialog" aria-labelledby="context-modal-title-idx" aria-hidden="true">
        <div class="context-modal__backdrop"></div>
        <div class="context-modal__content">
            <div class="context-modal__header">
                <h3 class="context-modal__title" id="context-modal-title-idx">Information</h3>
                <button type="button" class="context-modal__close" aria-label="Close modal">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <div class="context-modal__tabs">
                <button type="button" class="context-modal__tab active" data-tab="context">Search Context</button>
                <button type="button" class="context-modal__tab" data-tab="explanation">Why Recommended</button>
            </div>
            <div class="context-modal__body">
                <div class="context-modal__tab-content active" data-content="context">
                    <div class="context-modal__items">
                        {% for key, value in result.context.items() %}
                            {% if key not in ['hike_date', 'hike_start_date', 'hike_end_date'] %}
                                {% if key == 'time_available' %}
                                    {% set days = (value // (24 * 60)) %}
                                    {% set hours = ((value % (24 * 60)) // 60) %}
                                    <div class="context-modal__item">
                                        <span class="context-modal__label">{{ key.replace('_', ' ').title() }}:</span>
                                        <span class="context-modal__value">{% if days > 0 %}{{ days }} day{{ 's' if days != 1 else '' }}{% endif %}{% if days > 0 and hours > 0 %} {% endif %}{% if hours > 0 %}{{ hours }} hour{{ 's' if hours != 1 else '' }}{% endif %}{% if days == 0 and hours == 0 %}0 hours{% endif %}</span>
                                    </div>
                                {% else %}
                                    <div class="context-modal__item">
                                        <span class="context-modal__label">{{ key.replace('_', ' ').title() }}:</span>
                                        <span class="context-modal__value">{{ value }}</span>
                                    </div>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                <div class="context-modal__tab-content" data-content="explanation">
                    <div class="explanation-content" id="explanation-content-idx">
                        <div class="explanation-loading" id="explanation-loading-idx">
                            <p><span class="spinner">‚è≥</span><br>Generating explanation...</p>
                        </div>
                        <div class="explanation-loaded" id="explanation-loaded-idx">
                            <p class="explanation-text" id="explanation-text-idx"></p>
                            <div class="explanation-details">
                                <h4 class="explanation-details__title">Key Matching Factors:</h4>
                                <ul class="explanation-details__list" id="explanation-factors-idx"></ul>
                            </div>
                        </div>
                        <div class="explanation-error" id="explanation-error-idx">
                            <p>Unable to generate explanation. Please try again later.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# Trail data for map (JSON) #}
<script type="application/json" id="demo-trail-data-{{ result.scenario.user_id|default(result.user_id|default('1')) }}">
{{ {
    'exact': result.exact,
    'suggestions': result.suggestions,
    'collaborative': result.collaborative|default([]),
    'user_label': result.user_label|default('User'),
    'user_id': result.scenario.user_id|default(result.user_id|default('1'))
}|tojson }}
</script>
