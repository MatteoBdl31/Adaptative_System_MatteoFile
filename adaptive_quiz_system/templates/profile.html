{% extends "base.html" %}
{% block title %}Profile Dashboard{% endblock %}
{% block extra_head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
{% endblock %}
{% block content %}
    <div class="container profile-container">
        <!-- User Selector -->
        <div class="profile-header">
            <div class="user-selector-section">
                <label for="user-select">Select User:</label>
                <select id="user-select" class="user-select">
                    {% for u in users %}
                    <option value="{{ u.id }}" {% if u.id == user.id %}selected{% endif %}>
                        {{ u.name }} {% if u.detected_profile %}({{ u.detected_profile|profile_name_en }}){% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="profile-info-header">
                <h1>{{ user.name }}'s Profile Dashboard</h1>
                {% if user.detected_profile %}
                <span class="profile-badge">{{ user.detected_profile|profile_name_en }}</span>
                {% endif %}
            </div>
        </div>

        <!-- Dashboard Section: switcher sticks only until this section scrolls out -->
        <div class="dashboard-section">
            <div class="dashboard-switcher">
                <button class="dashboard-tab" data-dashboard="elevation">Elevation</button>
                <button class="dashboard-tab" data-dashboard="fitness">Fitness</button>
                <button class="dashboard-tab" data-dashboard="persistence">Persistence</button>
                <button class="dashboard-tab" data-dashboard="exploration">Exploration</button>
                <button class="dashboard-tab" data-dashboard="photography">Photography</button>
                <button class="dashboard-tab" data-dashboard="contemplative">Contemplative</button>
                <button class="dashboard-tab" data-dashboard="performance">Performance</button>
            </div>

            <div id="dashboard-content" class="dashboard-content">
                <!-- Dashboard views will be loaded here via JavaScript -->
                <div class="loading">Loading dashboard...</div>
            </div>
        </div>
        <p class="profile-my-trails-cta">
            <a href="{{ url_for('my_trails', user_id=user.id) }}" class="btn btn-primary">View My Trails</a>
        </p>
    </div>

    <script src="{{ url_for('static', filename='app.js') }}"></script>
    <script src="{{ url_for('static', filename='profile.js') }}"></script>
    <script>
        const currentUserId = {{ user.id }};
        const currentUserProfile = "{{ user.detected_profile or '' }}";
        const profileDashboardMap = {
            "elevation_lover": "elevation",
            "performance_athlete": "fitness",
            "casual": "persistence",
            "family": "persistence",
            "explorer": "exploration",
            "photographer": "photography",
            "contemplative": "contemplative"
        };
        const defaultDashboard = profileDashboardMap[currentUserProfile] || "performance";
        document.addEventListener('DOMContentLoaded', function() {
            const dashboardTab = document.querySelector(`[data-dashboard="${defaultDashboard}"]`);
            if (dashboardTab) dashboardTab.classList.add('active');
            if (typeof ProfileManager !== 'undefined') {
                ProfileManager.init(currentUserId, defaultDashboard);
            }
        });
    </script>
{% endblock %}
