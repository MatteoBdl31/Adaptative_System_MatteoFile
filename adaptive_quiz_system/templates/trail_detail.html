{% extends "base.html" %}
{% block title %}{{ trail.name }} ¬∑ Personalised Trail View{% endblock %}
{% block page_class %}detail-page{% endblock %}
{% block extra_head %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
{% endblock %}
{% block content %}
    <div class="detail-shell">
        <header class="page-header">
            <div class="page-header__left">
                {% set days = (context.time_available // (24 * 60)) %}
                {% set hours = ((context.time_available % (24 * 60)) // 60) %}
                <a class="link-pill" href="{{ url_for('recommendations', user_id=user.id, time_available_days=days, time_available_hours=hours, device=context.device, weather=context.weather, connection=context.connection, season=context.get('season', 'summer')) }}">‚Üê Back to personalised recommendations</a>
                <nav class="nav-inline">
                    <a href="{{ url_for('index') }}">Home</a>
                    <a href="{{ url_for('all_trails') }}">All Trails</a>
                    <a href="{{ url_for('profile', user_id=user.id) }}">Profile</a>
                </nav>
            </div>
            <div class="context-badges compact">
                {% set time_avail = context.time_available or 60 %}
                {% set days = (time_avail // (24 * 60)) %}
                {% set hours = ((time_avail % (24 * 60)) // 60) %}
                {% if days > 0 %}
                    <span class="badge">‚è± {{ days }} day{{ 's' if days != 1 else '' }}{% if hours > 0 %}, {{ hours }} hour{{ 's' if hours != 1 else '' }}{% endif %}</span>
                {% else %}
                    <span class="badge">‚è± {{ hours }} hour{{ 's' if hours != 1 else '' }}</span>
                {% endif %}
                <span class="badge">üì± {{ context.device|title }}</span>
                <span class="badge">üå§ {{ context.weather|title }}</span>
                <span class="badge">üì∂ {{ context.connection|title }}</span>
            </div>
        </header>

        <section class="trail-hero">
            <div class="hero-text">
                <p class="eyebrow">{{ (trail.region|default('french_alps'))|replace('_', ' ')|title }}</p>
                <h1>{{ trail.name }}</h1>
                <p class="subtitle">{{ trail.description }}</p>
                <div class="hero-tags">
                    <span class="pill difficulty-{{ 'easy' if trail.difficulty <= 3 else 'medium' if trail.difficulty <= 6 else 'hard' }}">
                        {% if trail.difficulty <= 3 %}Easy{% elif trail.difficulty <= 6 %}Medium{% else %}Hard{% endif %}
                    </span>
                    <span class="pill">‚≠ê {{ trail.popularity|default(7)|round(1) }}/10 popularity</span>
                    <span class="pill">{{ trail.trail_type.replace('_', ' ').title() }}</span>
                </div>
            </div>
            <div class="hero-metrics">
                <div class="metric">
                    <span>Distance</span>
                    <strong>{{ trail.distance|default('‚Äî') }} km</strong>
                </div>
                <div class="metric">
                    <span>Duration</span>
                    <strong>{{ trail.duration|format_duration }}</strong>
                </div>
                <div class="metric">
                    <span>Elevation gain</span>
                    <strong>{{ trail.elevation_gain|default('‚Äî') }} m</strong>
                </div>
                <div class="metric">
                    <span>Samples</span>
                    <strong>{{ (trail.elevation_profile|length) if trail.elevation_profile else 0 }}</strong>
                </div>
            </div>
        </section>

        <section class="layout-grid">
            <article class="panel-card map-panel">
                <div class="panel-header">
                    <div>
                        <h2>Trail geometry</h2>
                        <p>Real GPS trace with interactive map overlay.</p>
                    </div>
                    <div class="panel-meta">
                        <span class="badge">Lat {{ '%.3f'|format(trail.latitude|default(0)) }}</span>
                        <span class="badge">Lon {{ '%.3f'|format(trail.longitude|default(0)) }}</span>
                    </div>
                </div>
                {% if trail.latitude and trail.longitude %}
                <div id="trail-map" class="map-canvas"></div>
                {% else %}
                <div class="map-placeholder">Map data unavailable</div>
                {% endif %}
            </article>

            <article class="panel-card chart-panel">
                <div class="panel-header">
                    <div>
                        <h2>Elevation profile</h2>
                        <p>{{ "Ready for personalised pacing tips." if trail.elevation_profile else "Elevation data missing for this trail." }}</p>
                    </div>
                    <div class="panel-meta">
                        <span class="badge">Context: {{ user.fitness_level|title }}</span>
                    </div>
                </div>
                {% if trail.elevation_profile %}
                <canvas id="elevationChart" height="220"></canvas>
                {% else %}
                <div class="chart-placeholder">Elevation samples unavailable.</div>
                {% endif %}
            </article>
        </section>

        <section class="insights-grid">
            <article class="panel-card">
                <h3>Landscape highlights</h3>
                <div class="landscape-tags">
                    {% for landscape in trail.landscapes.split(',') %}
                    <span class="landscape-chip">{{ landscape.strip().title() }}</span>
                    {% endfor %}
                </div>
                <p class="muted">Perfect for {{ ", ".join(user.preferences) }} lovers.</p>
            </article>

            <article class="panel-card">
                <h3>Safety & logistics</h3>
                <ul class="meta-list">
                    <li><strong>Risks:</strong> {{ trail.safety_risks if trail.safety_risks != 'none' else 'None reported' }}</li>
                    <li><strong>Accessibility:</strong> {{ trail.accessibility or 'General hiking gear' }}</li>
                    {% if trail.closed_seasons %}
                    <li><strong>Closed seasons:</strong> {{ trail.closed_seasons }}</li>
                    {% else %}
                    <li><strong>Season access:</strong> Year-round with weather checks</li>
                    {% endif %}
                </ul>
                {% if context.weather != 'sunny' %}
                <p class="warning-chip">Weather alert: {{ context.weather|title }} mode activated</p>
                {% endif %}
            </article>

            <article class="panel-card">
                <h3>Context-aware tips</h3>
                <ul class="meta-list">
                    <li>Device: {{ context.device|title }} ¬∑ Connection: {{ context.connection|title }}</li>
                    {% set days = (context.time_available // (24 * 60)) %}
                    {% set hours = ((context.time_available % (24 * 60)) // 60) %}
                    <li>Suggested window: {% if days > 0 %}{{ days }} day{{ 's' if days != 1 else '' }}{% if hours > 0 %}, {{ hours }} hour{{ 's' if hours != 1 else '' }}{% endif %}{% else %}{{ hours }} hour{{ 's' if hours != 1 else '' }}{% endif %}</li>
                    <li>{% if context.connection == 'weak' %}Download map tiles before leaving signal range.{% else %}Streaming-friendly trail assets available.{% endif %}</li>
                </ul>
            </article>

            <article class="panel-card action-card">
                <h3>Status & feedback</h3>
                {% if not completed %}
                <form method="post" action="{{ url_for('complete_trail', user_id=user.id, trail_id=trail.trail_id) }}" class="completion-form">
                    <label>
                        <span>Actual duration (min)</span>
                        <input type="number" name="actual_duration" min="1" value="{{ trail.duration or 60 }}" required>
                    </label>
                    <label>
                        <span>Rating</span>
                        <input type="number" name="rating" min="1" max="5" value="5" required>
                    </label>
                    <button class="btn-primary">Mark as completed</button>
                </form>
                {% else %}
                <div class="completed-banner">‚úÖ Logged in your history</div>
                {% endif %}
            </article>
        </section>
    </div>
{% endblock %}
{% block extra_scripts %}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js" integrity="sha256-0mMJjjXNMTvEihQ6UkNzxaz2YsmiFjCwXTlzAIXazh8=" crossorigin="anonymous"></script>
    <script>
        const coordinatesGeoJSON = {{ trail.coordinates|tojson }};
        const elevationProfile = {{ (trail.elevation_profile or [])|tojson }};
        const mapEnabled = Boolean({{ 'true' if trail.latitude and trail.longitude else 'false' }});

        if (mapEnabled && typeof L !== 'undefined') {
            const map = L.map('trail-map');
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            const lat = {{ trail.latitude or 0 }};
            const lon = {{ trail.longitude or 0 }};
            const marker = L.marker([lat, lon]).addTo(map).bindPopup("{{ trail.name|escapejs }}");

            if (coordinatesGeoJSON && coordinatesGeoJSON.coordinates) {
                const latLngs = coordinatesGeoJSON.coordinates.map(coord => [coord[1], coord[0]]);
                const polyline = L.polyline(latLngs, { color: '#5b8df9', weight: 4, opacity: 0.85 }).addTo(map);
                map.fitBounds(polyline.getBounds(), { padding: [18, 18] });
            } else {
                map.setView([lat, lon], 12);
            }
        }

        if (elevationProfile.length && typeof Chart !== 'undefined') {
            const ctx = document.getElementById('elevationChart');
            if (ctx) {
                const labels = elevationProfile.map(point => (point.distance_m / 1000).toFixed(1));
                const data = elevationProfile.map(point => point.elevation_m);
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Elevation (m)',
                            data,
                            borderColor: '#5b8df9',
                            backgroundColor: 'rgba(91, 141, 249, 0.15)',
                            tension: 0.3,
                            fill: true,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        scales: {
                            x: { title: { text: 'Distance (km)', display: true } },
                            y: { title: { text: 'Elevation (m)', display: true } }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }
        }
    </script>
{% endblock %}

