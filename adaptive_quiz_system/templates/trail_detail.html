{% extends "base.html" %}
{% block title %}{{ trail.name }} ¬∑ Personalised Trail View{% endblock %}
{% block page_class %}detail-page{% endblock %}
{% block extra_head %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
{% endblock %}
{% block content %}
    <div class="container">
        <header class="page-header">
            <div class="page-header__left">
                {% set days = (context.time_available // (24 * 60)) %}
                {% set hours = ((context.time_available % (24 * 60)) // 60) %}
                <a class="btn btn-ghost" href="{{ url_for('recommendations', user_id=user.id, time_available_days=days, time_available_hours=hours, device=context.device, weather=context.weather, connection=context.connection, season=context.get('season', 'summer')) }}" style="margin-bottom: var(--space-md);">
                    ‚Üê Back to recommendations
                </a>
                <h1 class="page-header__title">{{ trail.name }}</h1>
                <p class="page-header__subtitle">{{ trail.description }}</p>
            </div>
            <div class="context-pills" style="margin-top: var(--space-lg);">
                {% set time_avail = context.time_available or 60 %}
                {% set days = (time_avail // (24 * 60)) %}
                {% set hours = ((time_avail % (24 * 60)) // 60) %}
                {% if days > 0 %}
                    <span class="badge">‚è± {{ days }} day{{ 's' if days != 1 else '' }}{% if hours > 0 %}, {{ hours }} hour{{ 's' if hours != 1 else '' }}{% endif %}</span>
                {% else %}
                    <span class="badge">‚è± {{ hours }} hour{{ 's' if hours != 1 else '' }}</span>
                {% endif %}
                <span class="badge">üì± {{ context.device|title }}</span>
                <span class="badge">üå§ {{ context.weather|title }}</span>
                <span class="badge">üì∂ {{ context.connection|title }}</span>
            </div>
        </header>

        <section class="card" style="margin-bottom: var(--space-xl);">
            <div class="grid grid-cols-4" style="gap: var(--space-lg);">
                <div class="text-center">
                    <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-primary); margin-bottom: var(--space-xs);">
                        {{ trail.distance|default('‚Äî') }} km
                    </div>
                    <div style="color: var(--color-text-secondary); font-size: var(--font-size-sm);">Distance</div>
                </div>
                <div class="text-center">
                    <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-primary); margin-bottom: var(--space-xs);">
                        {{ trail.duration|format_duration }}
                    </div>
                    <div style="color: var(--color-text-secondary); font-size: var(--font-size-sm);">Duration</div>
                </div>
                <div class="text-center">
                    <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-primary); margin-bottom: var(--space-xs);">
                        {{ trail.elevation_gain|default('‚Äî') }} m
                    </div>
                    <div style="color: var(--color-text-secondary); font-size: var(--font-size-sm);">Elevation Gain</div>
                </div>
                <div class="text-center">
                    <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-primary); margin-bottom: var(--space-xs);">
                        {% if trail.difficulty <= 3 %}Easy{% elif trail.difficulty <= 6 %}Medium{% else %}Hard{% endif %}
                    </div>
                    <div style="color: var(--color-text-secondary); font-size: var(--font-size-sm);">Difficulty</div>
                </div>
            </div>
        </section>

        <section class="grid grid-cols-2" style="gap: var(--space-xl); margin-bottom: var(--space-xl);">
            <article class="card">
                <div class="card__header">
                    <h2 class="card__title">Trail Geometry</h2>
                    <p class="card__description">Real GPS trace with interactive map overlay.</p>
                </div>
                {% if trail.latitude and trail.longitude %}
                <div id="trail-map" class="map-container" style="height: 400px;"></div>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state__icon">üó∫Ô∏è</div>
                    <p class="empty-state__description">Map data unavailable</p>
                </div>
                {% endif %}
            </article>

            <article class="card">
                <div class="card__header">
                    <h2 class="card__title">Elevation Profile</h2>
                    <p class="card__description">{{ "Ready for personalised pacing tips." if trail.elevation_profile else "Elevation data missing for this trail." }}</p>
                </div>
                {% if trail.elevation_profile %}
                <canvas id="elevationChart" style="max-height: 300px;"></canvas>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state__icon">‚õ∞Ô∏è</div>
                    <p class="empty-state__description">Elevation samples unavailable</p>
                </div>
                {% endif %}
            </article>
        </section>

        <section class="grid grid-cols-2" style="gap: var(--space-xl);">
            <article class="card">
                <h3 class="card__title" style="font-size: var(--font-size-xl); margin-bottom: var(--space-md);">Landscape Highlights</h3>
                <div class="context-pills" style="margin-bottom: var(--space-md);">
                    {% for landscape in trail.landscapes.split(',') %}
                    <span class="context-pill">{{ landscape.strip().title() }}</span>
                    {% endfor %}
                </div>
                <p class="text-muted">Perfect for {{ ", ".join(user.preferences) }} lovers.</p>
            </article>

            <article class="card">
                <h3 class="card__title" style="font-size: var(--font-size-xl); margin-bottom: var(--space-md);">Safety & Logistics</h3>
                <ul style="list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: var(--space-sm);">
                    <li><strong>Risks:</strong> {{ trail.safety_risks if trail.safety_risks != 'none' else 'None reported' }}</li>
                    <li><strong>Accessibility:</strong> {{ trail.accessibility or 'General hiking gear' }}</li>
                    {% if trail.closed_seasons %}
                    <li><strong>Closed seasons:</strong> {{ trail.closed_seasons }}</li>
                    {% else %}
                    <li><strong>Season access:</strong> Year-round with weather checks</li>
                    {% endif %}
                </ul>
                {% if context.weather != 'sunny' %}
                <div class="badge badge-warning" style="margin-top: var(--space-md);">Weather alert: {{ context.weather|title }} mode activated</div>
                {% endif %}
            </article>

            <article class="card">
                <h3 class="card__title" style="font-size: var(--font-size-xl); margin-bottom: var(--space-md);">Context-aware Tips</h3>
                <ul style="list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: var(--space-sm); color: var(--color-text-secondary);">
                    <li>Device: {{ context.device|title }} ¬∑ Connection: {{ context.connection|title }}</li>
                    {% set days = (context.time_available // (24 * 60)) %}
                    {% set hours = ((context.time_available % (24 * 60)) // 60) %}
                    <li>Suggested window: {% if days > 0 %}{{ days }} day{{ 's' if days != 1 else '' }}{% if hours > 0 %}, {{ hours }} hour{{ 's' if hours != 1 else '' }}{% endif %}{% else %}{{ hours }} hour{{ 's' if hours != 1 else '' }}{% endif %}</li>
                    <li>{% if context.connection == 'weak' %}Download map tiles before leaving signal range.{% else %}Streaming-friendly trail assets available.{% endif %}</li>
                </ul>
            </article>

            <article class="card">
                <h3 class="card__title" style="font-size: var(--font-size-xl); margin-bottom: var(--space-md);">Status & Feedback</h3>
                {% if not completed %}
                <form method="post" action="{{ url_for('complete_trail', user_id=user.id, trail_id=trail.trail_id) }}" style="display: flex; flex-direction: column; gap: var(--space-md);">
                    <div class="form-group">
                        <label class="form-label">Actual duration (min)</label>
                        <input type="number" name="actual_duration" min="1" value="{{ trail.duration or 60 }}" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Rating</label>
                        <input type="number" name="rating" min="1" max="5" value="5" class="form-input" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Mark as completed</button>
                </form>
                {% else %}
                <div class="badge badge-success" style="padding: var(--space-md); text-align: center;">‚úÖ Logged in your history</div>
                {% endif %}
            </article>
        </section>
    </div>
{% endblock %}
{% block extra_scripts %}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js" integrity="sha256-0mMJjjXNMTvEihQ6UkNzxaz2YsmiFjCwXTlzAIXazh8=" crossorigin="anonymous"></script>
    <script>
        const coordinatesGeoJSON = {{ trail.coordinates|tojson }};
        const elevationProfile = {{ (trail.elevation_profile or [])|tojson }};
        const mapEnabled = Boolean({{ 'true' if trail.latitude and trail.longitude else 'false' }});

        if (mapEnabled && typeof L !== 'undefined') {
            const map = L.map('trail-map');
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            const lat = {{ trail.latitude or 0 }};
            const lon = {{ trail.longitude or 0 }};
            const marker = L.marker([lat, lon]).addTo(map).bindPopup("{{ trail.name|escapejs }}");

            if (coordinatesGeoJSON && coordinatesGeoJSON.coordinates) {
                const latLngs = coordinatesGeoJSON.coordinates.map(coord => [coord[1], coord[0]]);
                const polyline = L.polyline(latLngs, { color: '#6366f1', weight: 4, opacity: 0.85 }).addTo(map);
                map.fitBounds(polyline.getBounds(), { padding: [18, 18] });
            } else {
                map.setView([lat, lon], 12);
            }
        }

        if (elevationProfile.length && typeof Chart !== 'undefined') {
            const ctx = document.getElementById('elevationChart');
            if (ctx) {
                const labels = elevationProfile.map(point => (point.distance_m / 1000).toFixed(1));
                const data = elevationProfile.map(point => point.elevation_m);
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Elevation (m)',
                            data,
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.15)',
                            tension: 0.3,
                            fill: true,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { 
                                title: { text: 'Distance (km)', display: true },
                                grid: { color: 'rgba(0, 0, 0, 0.05)' }
                            },
                            y: { 
                                title: { text: 'Elevation (m)', display: true },
                                grid: { color: 'rgba(0, 0, 0, 0.05)' }
                            }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }
        }
    </script>
{% endblock %}