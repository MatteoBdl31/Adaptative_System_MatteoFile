{% extends "base.html" %}
{% block title %}Adaptive Trails Â· {{ user.name }}{% endblock %}
{% block page_class %}recommendations-page{% endblock %}
{% block extra_head %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
{% endblock %}
{% block content %}
    <div class="container">
        <header class="page-header">
            <div class="page-header__left">
                <p class="page-header__label text-muted">Adaptive Recommendations</p>
                <h1 class="page-header__title">{{ user.name }} Â· {{ user.experience }} profile</h1>
                <p class="page-header__subtitle">Personalised shortlist based on your live context and long-term preferences.</p>
            </div>
            <div class="context-pills context-pills--header">
                {% set days = (context.time_available // (24 * 60)) %}
                {% set hours = ((context.time_available % (24 * 60)) // 60) %}
                {% if days > 0 %}
                    <span class="badge">â± {{ days }} day{{ 's' if days != 1 else '' }}{% if hours > 0 %}, {{ hours }} hour{{ 's' if hours != 1 else '' }}{% endif %}</span>
                {% else %}
                    <span class="badge">â± {{ hours }} hour{{ 's' if hours != 1 else '' }}</span>
                {% endif %}
                <span class="badge">ğŸ“± {{ context.device|title }}</span>
                <span class="badge">ğŸŒ¤ Desired: {{ context.weather|title }}</span>
                {% if context.forecast_weather %}
                    <span class="badge">ğŸŒ¦ Forecast: {{ context.forecast_weather|title }}</span>
                {% endif %}
                <span class="badge">ğŸ“¶ {{ context.connection|title }}</span>
                <span class="badge">ğŸ‚ {{ context.season|title }}</span>
                {% if context.hike_start_date %}
                    <span class="badge">ğŸ“… {{ context.hike_start_date|format_date }}{% if context.hike_end_date and context.hike_end_date != context.hike_start_date %} - {{ context.hike_end_date|format_date }}{% endif %}</span>
                {% endif %}
            </div>
        </header>

        <section class="card card--spaced">
            <div class="card__header">
                <h2 class="card__title">Overview</h2>
            </div>
            <div class="overview-grid">
                <div class="overview-stat">
                    <div class="overview-stat__number overview-stat__number--primary">{{ exact_matches|length }}</div>
                    <div class="overview-stat__label">â­ Exact matches</div>
                </div>
                <div class="overview-stat">
                    <div class="overview-stat__number overview-stat__number--accent">{{ suggestions|length }}</div>
                    <div class="overview-stat__label">ğŸ’¡ Smart suggestions</div>
                </div>
                <div class="overview-stat">
                    <div class="overview-stat__number overview-stat__number--secondary">{{ active_rules|length }}</div>
                    <div class="overview-stat__label">ğŸ§  Active rules</div>
                </div>
                <div class="overview-stat">
                    <div class="overview-stat__number overview-stat__number--text">{{ display_settings.display_mode|title }}</div>
                    <div class="overview-stat__label">ğŸ¯ Display mode</div>
                </div>
                {% if collaborative_recommendations %}
                <div class="overview-stat">
                    <div class="overview-stat__number overview-stat__number--collaborative">{{ collaborative_recommendations|length }}</div>
                    <div class="overview-stat__label">ğŸ‘¥ Collaborative</div>
                </div>
                {% endif %}
            </div>
        </section>

        <section class="card card--spaced">
            <div class="flex items-center justify-between card__header-row">
                <div>
                    <h2 class="card__title card__title--tight">Presentation Mode</h2>
                    <p class="card__description">Select how to view the personalised shortlist.</p>
                </div>
            </div>
            <div class="view-toggle">
                <button type="button" class="view-toggle__button active" data-view-target="map">ğŸ—ºï¸ Map + Context</button>
                <button type="button" class="view-toggle__button" data-view-target="cards">ğŸƒ Card Grid</button>
            </div>
        </section>

        {% if combined_trails %}
        <section class="view-panels" data-view-panels data-active-view="map">
            <article class="card view-panel" data-view-panel="map">
                <div class="card__header">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="card__title">Geo-personalised Overview</h2>
                            <p class="card__description">Hover markers to see why each trail surfaced for you.</p>
                        </div>
                        <span class="badge badge-primary">{{ combined_trails|length }} routes plotted</span>
                    </div>
                </div>
                <div id="recommendations-map" class="map-container map-container--recommendations"></div>
            </article>

            <article class="card view-panel hidden" data-view-panel="cards">
                {% if exact_matches %}
                <div class="section-spaced">
                    <div class="card__header">
                        <h2 class="card__title">Top Picks ({{ exact_matches|length }})</h2>
                        <p class="card__description">Trails that satisfy every adaptation rule.</p>
                    </div>
                    <div class="trail-grid trail-grid--spaced">
                        {% for trail in exact_matches %}
                        <div class="trail-card recommended">
                            <div class="trail-card__header">
                                <h3 class="trail-card__title">{{ trail.name }}</h3>
                                <span class="pill difficulty-{{ 'easy' if trail.difficulty <= 3 else 'medium' if trail.difficulty <= 6 else 'hard' }}">
                                    {% if trail.difficulty <= 3 %}Easy{% elif trail.difficulty <= 6 %}Medium{% else %}Hard{% endif %}
                                </span>
                            </div>
                            <p class="trail-card__description">{{ trail.description }}</p>
                            <div class="trail-card__stats">
                                <span>ğŸ“ {{ trail.distance or 'â€”' }} km</span>
                                <span>â± {{ trail.duration|format_duration }}</span>
                                <span>â›° {{ trail.elevation_gain or 'â€”' }} m</span>
                                {% if context.hike_start_date or context.hike_date %}
                                    {% if trail.forecast_weather %}
                                        <span class="badge">ğŸŒ¦ {{ trail.forecast_weather|title }}</span>
                                    {% else %}
                                        <span class="badge badge--muted">ğŸŒ¦ N/A</span>
                                    {% endif %}
                                {% endif %}
                            </div>
                            {% if trail.landscapes %}
                            <div class="context-pills" style="margin-top: var(--space-md);">
                                {% for landscape in trail.landscapes.split(',') %}
                                <span class="context-pill">{{ landscape.strip().title() }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                            {% set days = (context.time_available // (24 * 60)) %}
                            {% set hours = ((context.time_available % (24 * 60)) // 60) %}
                            <a class="btn btn-secondary btn--spaced" href="{{ url_for('trail_detail', user_id=user.id, trail_id=trail.trail_id, device=context.device, connection=context.connection, weather=context.weather, time_available_days=days, time_available_hours=hours, season=context.season) }}">Inspect Trail</a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if suggestions %}
                <div>
                    <div class="card__header">
                        <h2 class="card__title">Context-aware Suggestions ({{ suggestions|length }})</h2>
                        <p class="card__description">Ranked by relevance percentage.</p>
                    </div>
                    <div class="trail-grid trail-grid--spaced">
                        {% for trail in suggestions %}
                        <div class="trail-card suggested">
                            <div class="trail-card__header">
                                <h3 class="trail-card__title">{{ trail.name }}</h3>
                                <span class="badge badge-warning">{{ "%.0f"|format(trail.relevance_percentage|default(0.0)) }}% match</span>
                            </div>
                            <div class="trail-card__stats">
                                <span>ğŸ“ {{ trail.distance or 'â€”' }} km</span>
                                <span>â± {{ trail.duration|format_duration }}</span>
                                <span>â›° {{ trail.elevation_gain or 'â€”' }} m</span>
                                {% if context.hike_start_date or context.hike_date %}
                                    {% if trail.forecast_weather %}
                                        <span class="badge">ğŸŒ¦ {{ trail.forecast_weather|title }}</span>
                                    {% else %}
                                        <span class="badge badge--muted">ğŸŒ¦ N/A</span>
                                    {% endif %}
                                {% endif %}
                            </div>
                            {% if trail.landscapes %}
                            <div class="context-pills context-pills--spaced">
                                {% for landscape in trail.landscapes.split(',') %}
                                <span class="context-pill">{{ landscape.strip().title() }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                            {% if trail.unmatched_criteria %}
                            <div class="missing-criteria-box">
                                <small>Missing criteria:</small>
                                <ul>
                                    {% for criteria in trail.unmatched_criteria %}
                                    <li>â€¢ {{ criteria }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                            {% set days = (context.time_available // (24 * 60)) %}
                            {% set hours = ((context.time_available % (24 * 60)) // 60) %}
                            <a class="btn btn-secondary btn--spaced" href="{{ url_for('trail_detail', user_id=user.id, trail_id=trail.trail_id, device=context.device, connection=context.connection, weather=context.weather, time_available_days=days, time_available_hours=hours, season=context.season) }}">Inspect Trail</a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if collaborative_recommendations %}
                <div class="section-spaced section-spaced--top">
                    <div class="card__header">
                        <h2 class="card__title">ğŸ‘¥ Popular with Similar Hikers ({{ collaborative_recommendations|length }})</h2>
                        <p class="card__description">Trails loved by other {{ user.detected_profile|default('similar')|replace('_', ' ')|title }}s like you.</p>
                    </div>
                    <div class="trail-grid trail-grid--spaced">
                        {% for trail in collaborative_recommendations %}
                        <div class="trail-card collaborative card--collaborative">
                            <div class="trail-card__header">
                                <h3 class="trail-card__title">{{ trail.name }}</h3>
                                <span class="badge badge-info badge--collaborative">
                                    â­ {{ trail.collaborative_avg_rating|default('N/A') }}/5 ({{ trail.collaborative_user_count|default(0) }} users)
                                </span>
                            </div>
                            <p class="trail-card__description">{{ trail.description }}</p>
                            <div class="trail-card__stats">
                                <span>ğŸ“ {{ trail.distance or 'â€”' }} km</span>
                                <span>â± {{ trail.duration|format_duration }}</span>
                                <span>â›° {{ trail.elevation_gain or 'â€”' }} m</span>
                                {% if context.hike_start_date or context.hike_date %}
                                    {% if trail.forecast_weather %}
                                        <span class="badge">ğŸŒ¦ {{ trail.forecast_weather|title }}</span>
                                    {% else %}
                                        <span class="badge badge--muted">ğŸŒ¦ N/A</span>
                                    {% endif %}
                                {% endif %}
                            </div>
                            {% if trail.landscapes %}
                            <div class="context-pills context-pills--spaced">
                                {% for landscape in trail.landscapes.split(',') %}
                                <span class="context-pill">{{ landscape.strip().title() }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                            {% if trail.recommendation_reason %}
                            <div class="recommendation-reason-box">
                                <small>ğŸ’¡ {{ trail.recommendation_reason }}</small>
                            </div>
                            {% endif %}
                            {% set days = (context.time_available // (24 * 60)) %}
                            {% set hours = ((context.time_available % (24 * 60)) // 60) %}
                            <a class="btn btn-secondary btn--spaced" href="{{ url_for('trail_detail', user_id=user.id, trail_id=trail.trail_id, device=context.device, connection=context.connection, weather=context.weather, time_available_days=days, time_available_hours=hours, season=context.season) }}">Inspect Trail</a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </article>
        </section>
        {% else %}
        <section class="card">
            <div class="empty-state">
                <div class="empty-state__icon">ğŸ”ï¸</div>
                <h2 class="empty-state__title">No trails match this context</h2>
                <p class="empty-state__description">Try widening the time window, changing weather assumptions, or selecting another user persona.</p>
            </div>
        </section>
        {% endif %}

        {% if active_rules %}
        <section class="card card--spaced">
            <div class="card__header">
                <h2 class="card__title">Active Adaptation Rules</h2>
                <p class="card__description">Transparent logic powering this shortlist.</p>
            </div>
            <ul class="rules-list">
                {% for rule in active_rules %}
                <li class="rules-list__item">
                    <strong class="rules-list__title">{{ rule.description or rule.condition }}</strong>
                    <span class="rules-list__condition">{{ rule.condition }}</span>
                </li>
                {% endfor %}
            </ul>
        </section>
        {% endif %}
    </div>
{% endblock %}
{% block extra_scripts %}
    {% set days = (context.time_available // (24 * 60)) %}
    {% set hours = ((context.time_available % (24 * 60)) // 60) %}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="{{ url_for('static', filename='app.js') }}"></script>
    <script src="{{ url_for('static', filename='recommendations.js') }}"></script>
    <script id="recommendation-data" type="application/json">{{ combined_trails|tojson }}</script>
    <script>
        const dataElement = document.getElementById('recommendation-data');
        window.recommendationMapData = JSON.parse(dataElement.textContent);
        window.recommendationDetailUrl = function(trailId) {
            const base = "{{ url_for('trail_detail', user_id=user.id, trail_id='__REPLACE__', device=context.device, connection=context.connection, weather=context.weather, time_available_days=days, time_available_hours=hours, season=context.season) }}";
            return base.replace('__REPLACE__', trailId);
        };
    </script>
{% endblock %}