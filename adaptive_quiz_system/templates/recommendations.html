{% extends "base.html" %}
{% block title %}Adaptive Trails ¬∑ {{ user.name }}{% endblock %}
{% block page_class %}detail-page recommendations-page{% endblock %}
{% block extra_head %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
{% endblock %}
{% block content %}
    <div class="detail-shell">
        <header class="page-header">
            <div class="page-header__left">
                <p class="eyebrow">Adaptive recommendations</p>
                <h1>{{ user.name }} ¬∑ {{ user.experience }} profile</h1>
                <p class="subtitle">Personalised shortlist based on your live context and long-term preferences.</p>
            </div>
            <div class="context-badges compact">
                {% set days = (context.time_available // (24 * 60)) %}
                {% set hours = ((context.time_available % (24 * 60)) // 60) %}
                {% if days > 0 %}
                    <span class="badge">‚è± {{ days }} day{{ 's' if days != 1 else '' }}{% if hours > 0 %}, {{ hours }} hour{{ 's' if hours != 1 else '' }}{% endif %}</span>
                {% else %}
                    <span class="badge">‚è± {{ hours }} hour{{ 's' if hours != 1 else '' }}</span>
                {% endif %}
                <span class="badge">üì± {{ context.device|title }}</span>
                <span class="badge">üå§ Desired: {{ context.weather|title }}</span>
                {% if context.forecast_weather %}
                    <span class="badge">üå¶ Forecast: {{ context.forecast_weather|title }}</span>
                {% endif %}
                <span class="badge">üì∂ {{ context.connection|title }}</span>
                <span class="badge">üçÇ {{ context.season|title }}</span>
                {% if context.hike_start_date %}
                    <span class="badge">üìÖ {{ context.hike_start_date }}{% if context.hike_end_date and context.hike_end_date != context.hike_start_date %} - {{ context.hike_end_date }}{% endif %}</span>
                {% endif %}
            </div>
        </header>

        <section class="hero-metrics">
            <div class="metric">
                <span>‚≠ê Exact matches</span>
                <strong>{{ exact_matches|length }}</strong>
            </div>
            <div class="metric">
                <span>üí° Smart suggestions</span>
                <strong>{{ suggestions|length }}</strong>
            </div>
            <div class="metric">
                <span>üß† Active rules</span>
                <strong>{{ active_rules|length }}</strong>
            </div>
            <div class="metric">
                <span>üéØ Display mode</span>
                <strong>{{ display_settings.display_mode|title }}</strong>
            </div>
        </section>

        <section class="panel-card view-toggle" data-view-toggle>
            <div>
                <h2>Presentation mode</h2>
                <p>Select how to demo the personalised shortlist.</p>
            </div>
            <div class="toggle-buttons">
                <button type="button" class="toggle-btn is-active" data-view-target="map">Map + context</button>
                <button type="button" class="toggle-btn" data-view-target="cards">Card grid</button>
            </div>
        </section>

        {% if combined_trails %}
        <section class="view-panels" data-view-panels data-active-view="map">
            <article class="panel-card view-panel" data-view-panel="map">
                <div class="panel-header">
                    <div>
                        <h2>Geo-personalised overview</h2>
                        <p>Hover markers to see why each trail surfaced for you.</p>
                    </div>
                    <span class="badge">{{ combined_trails|length }} routes plotted</span>
                </div>
                <div id="recommendations-map" class="map-canvas"></div>
            </article>

            <article class="panel-card view-panel hide" data-view-panel="cards">
                {% if exact_matches %}
                <div class="cards-group">
                    <div class="panel-header">
                        <div>
                            <h2>Top picks ({{ exact_matches|length }})</h2>
                            <p>Trails that satisfy every adaptation rule.</p>
                        </div>
                    </div>
                    <div class="trails-grid modern">
                        {% for trail in exact_matches %}
                        <div class="trail-card modern recommended">
                            <div>
                                <div class="card-heading">
                                    <h3>{{ trail.name }}</h3>
                                    <span class="pill difficulty-{{ 'easy' if trail.difficulty <= 3 else 'medium' if trail.difficulty <= 6 else 'hard' }}">
                                        {% if trail.difficulty <= 3 %}Easy{% elif trail.difficulty <= 6 %}Medium{% else %}Hard{% endif %}
                                    </span>
                                </div>
                                <p class="trail-description">{{ trail.description }}</p>
                            </div>
                            <div class="trail-stats">
                                <span>üìè {{ trail.distance or '‚Äî' }} km</span>
                                <span>‚è± {{ trail.duration|format_duration }}</span>
                                <span>‚õ∞ {{ trail.elevation_gain or '‚Äî' }} m</span>
                                {% if context.hike_start_date or context.hike_date %}
                                    {% if trail.forecast_weather %}
                                        <span class="weather-stat">üå¶ {{ trail.forecast_weather|title }}</span>
                                    {% else %}
                                        <span class="weather-stat weather-unavailable" title="Weather forecast unavailable (API key may not be set)">üå¶ N/A</span>
                                    {% endif %}
                                {% endif %}
                            </div>
                            <div class="landscapes">
                                {% for landscape in trail.landscapes.split(',') %}
                                <span class="landscape-chip">{{ landscape.strip().title() }}</span>
                                {% endfor %}
                            </div>
                            {% set days = (context.time_available // (24 * 60)) %}
                            {% set hours = ((context.time_available % (24 * 60)) // 60) %}
                            <a class="btn-secondary" href="{{ url_for('trail_detail', user_id=user.id, trail_id=trail.trail_id, device=context.device, connection=context.connection, weather=context.weather, time_available_days=days, time_available_hours=hours, season=context.season) }}">Inspect trail</a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if suggestions %}
                <div class="cards-group">
                    <div class="panel-header">
                        <div>
                            <h2>Context-aware suggestions ({{ suggestions|length }})</h2>
                            <p>Ranked by relevance percentage.</p>
                        </div>
                    </div>
                    <div class="trails-grid modern">
                        {% for trail in suggestions %}
                        <div class="trail-card modern suggested">
                            <div class="card-heading">
                                <h3>{{ trail.name }}</h3>
                                <span class="relevance-badge">{{ "%.0f"|format(trail.relevance_percentage|default(0.0)) }}% match</span>
                            </div>
                            <div class="trail-stats">
                                <span>üìè {{ trail.distance or '‚Äî' }} km</span>
                                <span>‚è± {{ trail.duration|format_duration }}</span>
                                <span>‚õ∞ {{ trail.elevation_gain or '‚Äî' }} m</span>
                                {% if context.hike_start_date or context.hike_date %}
                                    {% if trail.forecast_weather %}
                                        <span class="weather-stat">üå¶ {{ trail.forecast_weather|title }}</span>
                                    {% else %}
                                        <span class="weather-stat weather-unavailable" title="Weather forecast unavailable (API key may not be set)">üå¶ N/A</span>
                                    {% endif %}
                                {% endif %}
                            </div>
                            <div class="landscapes">
                                {% for landscape in trail.landscapes.split(',') %}
                                <span class="landscape-chip">{{ landscape.strip().title() }}</span>
                                {% endfor %}
                            </div>
                            {% if context.hike_start_date or context.hike_date %}
                            <div class="weather-forecast-info">
                                <small class="weather-label">Weather forecast for {{ context.hike_start_date or context.hike_date }}:</small>
                                {% if trail.forecast_weather %}
                                    <span class="weather-badge weather-{{ trail.forecast_weather }}">üå¶ {{ trail.forecast_weather|title }}</span>
                                {% else %}
                                    <span class="weather-badge weather-unavailable">üå¶ Unavailable</span>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% if trail.matched_criteria %}
                            <div class="criteria-tags">
                                {% for criteria in trail.matched_criteria %}
                                <span class="criteria-tag">{{ criteria }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                            {% if trail.unmatched_criteria %}
                            <div class="unmatched-criteria">
                                <small class="unmatched-label">Missing criteria:</small>
                                <ul class="unmatched-list">
                                    {% for criteria in trail.unmatched_criteria %}
                                    <li class="unmatched-item">{{ criteria }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                            {% set days = (context.time_available // (24 * 60)) %}
                            {% set hours = ((context.time_available % (24 * 60)) // 60) %}
                            <a class="btn-secondary" href="{{ url_for('trail_detail', user_id=user.id, trail_id=trail.trail_id, device=context.device, connection=context.connection, weather=context.weather, time_available_days=days, time_available_hours=hours, season=context.season) }}">Inspect trail</a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </article>
        </section>
        {% else %}
        <section class="panel-card">
            <h2>No trails match this context</h2>
            <p class="muted">Try widening the time window, changing weather assumptions, or selecting another user persona.</p>
        </section>
        {% endif %}

        {% if active_rules %}
        <section class="panel-card rules-panel">
            <div class="panel-header">
                <div>
                    <h2>Active adaptation rules</h2>
                    <p>Transparent logic powering this shortlist.</p>
                </div>
            </div>
            <ul class="rules-list">
                {% for rule in active_rules %}
                <li>
                    <strong>{{ rule.description or rule.condition }}</strong>
                    <span>{{ rule.condition }}</span>
                </li>
                {% endfor %}
            </ul>
        </section>
        {% endif %}
    </div>
{% endblock %}
{% block extra_scripts %}
    {% set days = (context.time_available // (24 * 60)) %}
    {% set hours = ((context.time_available % (24 * 60)) // 60) %}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script id="recommendation-data" type="application/json">{{ combined_trails|tojson }}</script>
    <script>
        const dataElement = document.getElementById('recommendation-data');
        window.recommendationMapData = JSON.parse(dataElement.textContent);
        window.recommendationDetailUrl = function(trailId) {
            const base = "{{ url_for('trail_detail', user_id=user.id, trail_id='__REPLACE__', device=context.device, connection=context.connection, weather=context.weather, time_available_days=days, time_available_hours=hours, season=context.season) }}";
            return base.replace('__REPLACE__', trailId);
        };
    </script>
{% endblock %}

