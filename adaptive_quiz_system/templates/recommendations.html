{% extends "base.html" %}
{% block title %}Adaptive Trails ¬∑ {{ user.name }}{% endblock %}
{% block page_class %}detail-page recommendations-page{% endblock %}
{% block extra_head %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
{% endblock %}
{% block content %}
    <div class="detail-shell">
        <header class="page-header">
            <div class="page-header__left">
                <p class="eyebrow">Adaptive recommendations</p>
                <h1>{{ user.name }} ¬∑ {{ user.experience }} profile</h1>
                <p class="subtitle">Personalised shortlist based on your live context and long-term preferences.</p>
            </div>
            <div class="context-badges compact">
                <span class="badge">‚è± {{ context.time_available }} min</span>
                <span class="badge">üì± {{ context.device|title }}</span>
                <span class="badge">üå§ {{ context.weather|title }}</span>
                <span class="badge">üì∂ {{ context.connection|title }}</span>
                <span class="badge">üçÇ {{ context.season|title }}</span>
                <span class="badge">üïê {{ context.time_of_day|title }}</span>
            </div>
        </header>

        <section class="hero-metrics">
            <div class="metric">
                <span>‚≠ê Exact matches</span>
                <strong>{{ exact_matches|length }}</strong>
            </div>
            <div class="metric">
                <span>üí° Smart suggestions</span>
                <strong>{{ suggestions|length }}</strong>
            </div>
            <div class="metric">
                <span>üß† Active rules</span>
                <strong>{{ active_rules|length }}</strong>
            </div>
            <div class="metric">
                <span>üéØ Display mode</span>
                <strong>{{ display_settings.display_mode|title }}</strong>
            </div>
        </section>

        <section class="panel-card view-toggle" data-view-toggle>
            <div>
                <h2>Presentation mode</h2>
                <p>Select how to demo the personalised shortlist.</p>
            </div>
            <div class="toggle-buttons">
                <button type="button" class="toggle-btn is-active" data-view-target="map">Map + context</button>
                <button type="button" class="toggle-btn" data-view-target="cards">Card grid</button>
            </div>
        </section>

        {% if combined_trails %}
        <section class="view-panels" data-view-panels data-active-view="map">
            <article class="panel-card view-panel" data-view-panel="map">
                <div class="panel-header">
                    <div>
                        <h2>Geo-personalised overview</h2>
                        <p>Hover markers to see why each trail surfaced for you.</p>
                    </div>
                    <span class="badge">{{ combined_trails|length }} routes plotted</span>
                </div>
                <div id="recommendations-map" class="map-canvas"></div>
            </article>

            <article class="panel-card view-panel hide" data-view-panel="cards">
                {% if exact_matches %}
                <div class="cards-group">
                    <div class="panel-header">
                        <div>
                            <h2>Top picks ({{ exact_matches|length }})</h2>
                            <p>Trails that satisfy every adaptation rule.</p>
                        </div>
                    </div>
                    <div class="trails-grid modern">
                        {% for trail in exact_matches %}
                        <div class="trail-card modern recommended">
                            <div>
                                <div class="card-heading">
                                    <h3>{{ trail.name }}</h3>
                                    <span class="pill difficulty-{{ 'easy' if trail.difficulty <= 3 else 'medium' if trail.difficulty <= 6 else 'hard' }}">
                                        {% if trail.difficulty <= 3 %}Easy{% elif trail.difficulty <= 6 %}Medium{% else %}Hard{% endif %}
                                    </span>
                                </div>
                                <p class="trail-description">{{ trail.description }}</p>
                            </div>
                            <div class="trail-stats">
                                <span>üìè {{ trail.distance or '‚Äî' }} km</span>
                                <span>‚è± {{ trail.duration or '‚Äî' }} min</span>
                                <span>‚õ∞ {{ trail.elevation_gain or '‚Äî' }} m</span>
                            </div>
                            <div class="landscapes">
                                {% for landscape in trail.landscapes.split(',') %}
                                <span class="landscape-chip">{{ landscape.strip().title() }}</span>
                                {% endfor %}
                            </div>
                            {% if trail.recommendation_reasons %}
                            <p class="muted">Why: {{ trail.recommendation_reasons|join(', ') }}</p>
                            {% endif %}
                            <a class="btn-secondary" href="{{ url_for('trail_detail', user_id=user.id, trail_id=trail.trail_id, device=context.device, connection=context.connection, weather=context.weather, time_available=context.time_available, season=context.season, time_of_day=context.time_of_day) }}">Inspect trail</a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if suggestions %}
                <div class="cards-group">
                    <div class="panel-header">
                        <div>
                            <h2>Context-aware suggestions ({{ suggestions|length }})</h2>
                            <p>Ranked by relevance percentage.</p>
                        </div>
                    </div>
                    <div class="trails-grid modern">
                        {% for trail in suggestions %}
                        <div class="trail-card modern suggested">
                            <div class="card-heading">
                                <h3>{{ trail.name }}</h3>
                                <span class="relevance-badge">{{ "%.0f"|format(trail.relevance_percentage) }}% match</span>
                            </div>
                            <div class="trail-stats">
                                <span>üìè {{ trail.distance or '‚Äî' }} km</span>
                                <span>‚è± {{ trail.duration or '‚Äî' }} min</span>
                                <span>‚õ∞ {{ trail.elevation_gain or '‚Äî' }} m</span>
                            </div>
                            <div class="landscapes">
                                {% for landscape in trail.landscapes.split(',') %}
                                <span class="landscape-chip">{{ landscape.strip().title() }}</span>
                                {% endfor %}
                            </div>
                            {% if trail.matched_criteria %}
                            <div class="criteria-tags">
                                {% for criteria in trail.matched_criteria %}
                                <span class="criteria-tag">{{ criteria }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                            <a class="btn-secondary" href="{{ url_for('trail_detail', user_id=user.id, trail_id=trail.trail_id, device=context.device, connection=context.connection, weather=context.weather, time_available=context.time_available, season=context.season, time_of_day=context.time_of_day) }}">Inspect trail</a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </article>
        </section>
        {% else %}
        <section class="panel-card">
            <h2>No trails match this context</h2>
            <p class="muted">Try widening the time window, changing weather assumptions, or selecting another user persona.</p>
        </section>
        {% endif %}

        {% if active_rules %}
        <section class="panel-card rules-panel">
            <div class="panel-header">
                <div>
                    <h2>Active adaptation rules</h2>
                    <p>Transparent logic powering this shortlist.</p>
                </div>
            </div>
            <ul class="rules-list">
                {% for rule in active_rules %}
                <li>
                    <strong>{{ rule.description or rule.condition }}</strong>
                    <span>{{ rule.condition }}</span>
                </li>
                {% endfor %}
            </ul>
        </section>
        {% endif %}
    </div>
{% endblock %}
{% block extra_scripts %}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        window.recommendationMapData = {{ combined_trails|tojson }};
        window.recommendationDetailUrl = function(trailId) {
            const base = "{{ url_for('trail_detail', user_id=user.id, trail_id='__REPLACE__', device=context.device, connection=context.connection, weather=context.weather, time_available=context.time_available, season=context.season, time_of_day=context.time_of_day) }}";
            return base.replace('__REPLACE__', trailId);
        };
    </script>
{% endblock %}

