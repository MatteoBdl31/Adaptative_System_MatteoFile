<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trail Recommendations - {{ user.name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèîÔ∏è Recommended Trails for {{ user.name }}</h1>
            <nav class="nav-links">
                <a href="{{ url_for('index') }}">Home</a>
                <a href="{{ url_for('all_trails') }}">All Trails</a>
                <a href="{{ url_for('profile', user_id=user.id) }}">Profile</a>
                <a href="{{ url_for('dashboard', user_id=user.id) }}">Dashboard</a>
            </nav>
        </header>

        <div class="context-info">
            <h3>Current Context</h3>
            <div class="context-badges">
                <span class="badge">‚è±Ô∏è {{ context.time_available }} min</span>
                <span class="badge">üì± {{ context.device }}</span>
                <span class="badge">üå§Ô∏è {{ context.weather }}</span>
                <span class="badge">üì∂ {{ context.connection }}</span>
                <span class="badge">üçÇ {{ context.season }}</span>
                <span class="badge">üïê {{ context.time_of_day }}</span>
            </div>
        </div>

        {% if active_rules %}
        <div class="rules-info">
            <h3>Active Adaptation Rules</h3>
            <ul>
                {% for rule in active_rules %}
                <li>{{ rule.description }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="trails-container {{ 'compact' if display_settings.display_mode == 'compact' else 'full' }}">
            {% set all_trails = exact_matches + suggestions %}
            {% if all_trails %}
                {% if exact_matches or suggestions %}
                <div class="trails-map-overview" style="margin-bottom: 30px;">
                    <h2>üìç All Recommended Trails on Map</h2>
                    <div id="recommended-trails-map" style="height: 400px; width: 100%; border-radius: 8px; margin-bottom: 30px;"></div>
                </div>
                {% endif %}
                
                {% if exact_matches %}
                <div class="recommendations-section">
                    <h2>‚≠ê Recommended Trails ({{ exact_matches|length }})</h2>
                    <p class="section-description">These trails perfectly match your criteria and context.</p>
                    
                    <div class="trails-grid">
                        {% for trail in exact_matches %}
                        <div class="trail-card recommended">
                            {% if not display_settings.hide_images %}
                            <div class="trail-image-placeholder">
                                üèûÔ∏è
                            </div>
                            {% endif %}
                            <div class="trail-content">
                                <h3>{{ trail.name }}</h3>
                                <div class="trail-stats">
                                    <span class="difficulty-badge difficulty-{{ 'easy' if trail.difficulty <= 3 else 'medium' if trail.difficulty <= 6 else 'hard' }}">
                                        {% if trail.difficulty <= 3 %}Easy
                                        {% elif trail.difficulty <= 6 %}Medium
                                        {% else %}Hard{% endif %}
                                    </span>
                                    <span>üìè {% if trail.distance is not none %}{{ trail.distance }}{% else %}N/A{% endif %} km</span>
                                    <span>‚è±Ô∏è {{ trail.duration }} min</span>
                                    <span>‚õ∞Ô∏è {{ trail.elevation_gain }}m</span>
                                </div>
                                <p class="trail-description">{{ trail.description }}</p>
                                <div class="trail-features">
                                    <div class="landscapes">
                                        {% for landscape in trail.landscapes.split(',') %}
                                        <span class="landscape-tag">{{ landscape.strip() }}</span>
                                        {% endfor %}
                                    </div>
                                    <div class="accessibility">
                                        {% if trail.accessibility %}
                                        <span class="access-tag">{{ trail.accessibility.split(',')[0] }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if trail.recommendation_reasons %}
                                <div class="recommendation-reasons">
                                    <strong>Why recommended:</strong>
                                    <ul>
                                        {% for reason in trail.recommendation_reasons[:2] %}
                                        <li>{{ reason }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}
                                <a href="{{ url_for('trail_detail', user_id=user.id, trail_id=trail.trail_id, device=context.device, connection=context.connection, weather=context.weather) }}" 
                                   class="btn-secondary">View Details</a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% if suggestions %}
                <div class="suggestions-section">
                    <h2>üí° Suggested Trails ({{ suggestions|length }})</h2>
                    <p class="section-description">These trails match some of your criteria and are sorted by relevance.</p>
                    
                    <div class="trails-grid">
                        {% for trail in suggestions %}
                        <div class="trail-card suggested">
                            {% if not display_settings.hide_images %}
                            <div class="trail-image-placeholder">
                                üèûÔ∏è
                            </div>
                            {% endif %}
                            <div class="trail-content">
                                <h3>{{ trail.name }}</h3>
                                {% if trail.relevance_total > 0 %}
                                <div class="relevance-info">
                                    <span class="relevance-badge">Relevance: {{ "%.0f"|format(trail.relevance_percentage) }}%</span>
                                    <span class="matched-criteria">({{ trail.matched_criteria|length }}/{{ trail.relevance_total }} criteria matched)</span>
                                </div>
                                {% endif %}
                                <div class="trail-stats">
                                    <span class="difficulty-badge difficulty-{{ 'easy' if trail.difficulty <= 3 else 'medium' if trail.difficulty <= 6 else 'hard' }}">
                                        {% if trail.difficulty <= 3 %}Easy
                                        {% elif trail.difficulty <= 6 %}Medium
                                        {% else %}Hard{% endif %}
                                    </span>
                                    <span>üìè {% if trail.distance is not none %}{{ trail.distance }}{% else %}N/A{% endif %} km</span>
                                    <span>‚è±Ô∏è {{ trail.duration }} min</span>
                                    <span>‚õ∞Ô∏è {{ trail.elevation_gain }}m</span>
                                </div>
                                <p class="trail-description">{{ trail.description }}</p>
                                <div class="trail-features">
                                    <div class="landscapes">
                                        {% for landscape in trail.landscapes.split(',') %}
                                        <span class="landscape-tag">{{ landscape.strip() }}</span>
                                        {% endfor %}
                                    </div>
                                    <div class="accessibility">
                                        {% if trail.accessibility %}
                                        <span class="access-tag">{{ trail.accessibility.split(',')[0] }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if trail.matched_criteria %}
                                <div class="matched-criteria-info">
                                    <strong>Matched criteria:</strong>
                                    <span class="criteria-tags">
                                        {% for criteria in trail.matched_criteria %}
                                        <span class="criteria-tag">{{ criteria }}</span>
                                        {% endfor %}
                                    </span>
                                </div>
                                {% endif %}
                                <a href="{{ url_for('trail_detail', user_id=user.id, trail_id=trail.trail_id, device=context.device, connection=context.connection, weather=context.weather) }}" 
                                   class="btn-secondary">View Details</a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            {% else %}
                <div class="no-trails">
                    <p>No trails match your current context. Try adjusting your preferences or context.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        // Initialize map for recommended trails
        document.addEventListener('DOMContentLoaded', function() {
            // Check if Leaflet is loaded
            if (typeof L === 'undefined') {
                console.error('Leaflet library not loaded!');
                return;
            }
            
            // Combine exact matches and suggestions for map display
            var recommendedTrailsData = [
                {% for trail in exact_matches %}
                {% if trail.latitude and trail.longitude %}
                {
                    id: "{{ trail.trail_id }}",
                    name: {{ trail.name|tojson }},
                    lat: {{ trail.latitude }},
                    lon: {{ trail.longitude }},
                    difficulty: {{ trail.difficulty }},
                    distance: {% if trail.distance is not none %}{{ trail.distance }}{% else %}null{% endif %},
                    coordinates: {% if trail.coordinates %}{{ trail.coordinates|tojson }}{% else %}null{% endif %},
                    url: "{{ url_for('trail_detail', user_id=user.id, trail_id=trail.trail_id, device=context.device, connection=context.connection, weather=context.weather) }}",
                    type: "recommended"
                }{% if not loop.last or suggestions %},{% endif %}
                {% endif %}
                {% endfor %}
                {% for trail in suggestions %}
                {% if trail.latitude and trail.longitude %}
                {
                    id: "{{ trail.trail_id }}",
                    name: {{ trail.name|tojson }},
                    lat: {{ trail.latitude }},
                    lon: {{ trail.longitude }},
                    difficulty: {{ trail.difficulty }},
                    distance: {% if trail.distance is not none %}{{ trail.distance }}{% else %}null{% endif %},
                    coordinates: {% if trail.coordinates %}{{ trail.coordinates|tojson }}{% else %}null{% endif %},
                    url: "{{ url_for('trail_detail', user_id=user.id, trail_id=trail.trail_id, device=context.device, connection=context.connection, weather=context.weather) }}",
                    type: "suggested"
                }{% if not loop.last %},{% endif %}
                {% endif %}
                {% endfor %}
            ];
            
            // Only initialize map if we have trails to show
            if (recommendedTrailsData.length > 0) {
                var mapContainer = document.getElementById('recommended-trails-map');
                if (!mapContainer) {
                    console.error('Map container not found!');
                    return;
                }
                
                // Wait a bit to ensure the container is ready
                setTimeout(function() {
                    try {
                        var recommendedMap = L.map('recommended-trails-map');
                        
                        // Add OpenStreetMap tiles
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                            maxZoom: 19
                        }).addTo(recommendedMap);
                        
                        // Parse coordinates from JSON string if needed
                        recommendedTrailsData.forEach(function(trail) {
                            if (trail.coordinates) {
                                if (typeof trail.coordinates === 'string') {
                                    try {
                                        trail.coordinates = JSON.parse(trail.coordinates);
                                    } catch(e) {
                                        console.log('Could not parse coordinates for trail ' + trail.id + ':', e);
                                        trail.coordinates = null;
                                    }
                                }
                            }
                        });
                        
                        // Add markers and paths for recommended trails
                        var bounds = [];
                        var polylines = [];
                        
                        recommendedTrailsData.forEach(function(trail) {
                            // Use different colors for recommended vs suggested
                            var iconColor = trail.type === 'recommended' ? '#667eea' : '#f59e0b';
                            var icon = L.divIcon({
                                className: 'custom-marker',
                                html: '<div style="background-color: ' + iconColor + '; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            });
                            
                            var marker = L.marker([trail.lat, trail.lon], {icon: icon})
                                .addTo(recommendedMap)
                                .bindPopup('<strong><a href="' + trail.url + '">' + trail.name + '</a></strong><br>' +
                                          'Type: ' + (trail.type === 'recommended' ? '‚≠ê Recommended' : 'üí° Suggested') + '<br>' +
                                          'Difficulty: ' + (trail.difficulty <= 3 ? 'Easy' : trail.difficulty <= 6 ? 'Medium' : 'Hard') + '<br>' +
                                          'Distance: ' + (trail.distance !== null ? trail.distance + ' km' : 'N/A'));
                            bounds.push([trail.lat, trail.lon]);
                            
                            // Add trail path if coordinates available
                            if (trail.coordinates && trail.coordinates.coordinates && Array.isArray(trail.coordinates.coordinates)) {
                                // Convert GeoJSON coordinates [lon, lat] to Leaflet [lat, lon]
                                var latLngs = trail.coordinates.coordinates.map(function(coord) {
                                    return [coord[1], coord[0]];
                                });
                                
                                var polyline = L.polyline(latLngs, {
                                    color: '#667eea',
                                    weight: 4,
                                    opacity: 0.7
                                }).addTo(recommendedMap);
                                
                                polylines.push(polyline);
                                
                                // Extend bounds to include the entire trail path
                                var polylineBounds = polyline.getBounds();
                                bounds.push(polylineBounds.getSouthWest());
                                bounds.push(polylineBounds.getNorthEast());
                            }
                        });
                        
                        // Fit map to show all markers and paths
                        if (bounds.length > 0) {
                            recommendedMap.fitBounds(bounds, {padding: [20, 20]});
                        } else {
                            recommendedMap.setView([45.8, 6.5], 8); // Default to French Alps center
                        }
                        
                        // Invalidate map size to ensure it renders properly
                        setTimeout(function() {
                            if (recommendedMap) {
                                recommendedMap.invalidateSize();
                            }
                        }, 200);
                        
                        console.log('Recommended trails map initialized with', recommendedTrailsData.length, 'trails');
                    } catch(e) {
                        console.error('Error initializing recommended trails map:', e);
                    }
                }, 100);
            } else {
                console.log('No recommended trails with coordinates to display on map');
            }
        });
    </script>
</body>
</html>

